name: Setup Cloudflare Logpush

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'create'
        type: choice
        options:
          - create
          - list
          - delete

env:
  ACCOUNT_ID: df52a0cfc6c1765f726a830ef84ba78c
  WORKER_NAME: spotify-genre-sorter
  BETTERSTACK_HOST: s1624750.eu-nbg-2.betterstackdata.com

jobs:
  logpush:
    runs-on: ubuntu-latest
    steps:
      - name: List existing Logpush jobs
        if: github.event.inputs.action == 'list'
        run: |
          echo "üìã Listing existing Logpush jobs..."
          curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ env.ACCOUNT_ID }}/logpush/jobs" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" | jq '.'

      - name: Create Logpush job for Workers Trace Events
        if: github.event.inputs.action == 'create'
        run: |
          echo "üîß Creating Logpush job for Workers Trace Events..."

          # URL-encode the destination with BetterStack auth header
          DESTINATION="https://${{ env.BETTERSTACK_HOST }}?header_Authorization=Bearer%20${{ secrets.BETTERSTACK_LOGPUSH_TOKEN }}"

          # Create the logpush job
          RESPONSE=$(curl -s -X POST \
            "https://api.cloudflare.com/client/v4/accounts/${{ env.ACCOUNT_ID }}/logpush/jobs" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{
              "name": "'"${{ env.WORKER_NAME }}"'-traces-to-betterstack",
              "destination_conf": "'"${DESTINATION}"'",
              "dataset": "workers_trace_events",
              "enabled": true,
              "output_options": {
                "field_names": [
                  "Event",
                  "EventTimestampMs",
                  "Outcome",
                  "Exceptions",
                  "Logs",
                  "ScriptName",
                  "ScriptVersion",
                  "DispatchNamespace"
                ]
              },
              "filter": {
                "where": {
                  "key": "ScriptName",
                  "operator": "eq",
                  "value": "'"${{ env.WORKER_NAME }}"'"
                }
              }
            }')

          echo "$RESPONSE" | jq '.'

          # Check if successful
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" = "true" ]; then
            JOB_ID=$(echo "$RESPONSE" | jq -r '.result.id')
            echo ""
            echo "‚úÖ Logpush job created successfully!"
            echo "   Job ID: $JOB_ID"
            echo "   Dataset: workers_trace_events"
            echo "   Destination: BetterStack (${{ env.BETTERSTACK_HOST }})"
            echo "   Filter: ScriptName = ${{ env.WORKER_NAME }}"
          else
            echo ""
            echo "‚ùå Failed to create Logpush job"
            ERRORS=$(echo "$RESPONSE" | jq -r '.errors[]?.message // "Unknown error"')
            echo "   Error: $ERRORS"

            # Check if job already exists
            if echo "$ERRORS" | grep -qi "already exists"; then
              echo ""
              echo "‚ÑπÔ∏è  A Logpush job for this destination may already exist."
              echo "   Run with action 'list' to see existing jobs."
            fi
            exit 1
          fi

      - name: Delete Logpush jobs
        if: github.event.inputs.action == 'delete'
        run: |
          echo "üóëÔ∏è Fetching Logpush jobs to delete..."

          # Get all jobs
          JOBS=$(curl -s -X GET \
            "https://api.cloudflare.com/client/v4/accounts/${{ env.ACCOUNT_ID }}/logpush/jobs" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")

          # Find jobs matching our worker
          JOB_IDS=$(echo "$JOBS" | jq -r '.result[] | select(.name | contains("'"${{ env.WORKER_NAME }}"'")) | .id')

          if [ -z "$JOB_IDS" ]; then
            echo "‚ÑπÔ∏è  No Logpush jobs found for ${{ env.WORKER_NAME }}"
            exit 0
          fi

          for JOB_ID in $JOB_IDS; do
            echo "Deleting job $JOB_ID..."
            curl -s -X DELETE \
              "https://api.cloudflare.com/client/v4/accounts/${{ env.ACCOUNT_ID }}/logpush/jobs/$JOB_ID" \
              -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
              -H "Content-Type: application/json" | jq '.'
          done

          echo "‚úÖ Logpush jobs deleted"
