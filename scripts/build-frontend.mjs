#!/usr/bin/env node
/**
 * Build script that combines separated frontend files into a single TypeScript file
 *
 * This combines:
 * - src/frontend/styles.css
 * - src/frontend/body.html
 * - src/frontend/app.js
 *
 * Into: src/generated/frontend.ts
 *
 * Note: The extracted files preserve the escape sequences from the original
 * template literal, so we don't need to re-escape them.
 */

import { readFileSync, writeFileSync, mkdirSync } from 'fs';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';

const __dirname = dirname(fileURLToPath(import.meta.url));
const rootDir = join(__dirname, '..');

const frontendDir = join(rootDir, 'src/frontend');
const generatedDir = join(rootDir, 'src/generated');

// Read source files
const css = readFileSync(join(frontendDir, 'styles.css'), 'utf-8');
const bodyHtml = readFileSync(join(frontendDir, 'body.html'), 'utf-8');
const js = readFileSync(join(frontendDir, 'app.js'), 'utf-8');

// The CSS doesn't have template expressions, but may have backticks in comments
// We need to escape only unescaped backticks
function escapeCss(str) {
  // Only escape backticks that aren't already escaped
  return str.replace(/(?<!\\)`/g, '\\`');
}

// Escape specific sequences so they survive template literal embedding
// In template literals, backslash sequences get interpreted (backslash consumed)
// We need to preserve \', \n, \r, \t in the output
// The source file (app.js) already has escaped backticks (\`) and template expressions (\${)
// from the previous extraction, so we only escape unescaped ones
// Use negative lookbehind to NOT escape sequences already escaped
function escapeJs(str) {
  return str
    .replace(/(?<!\\)`/g, "\\`")      // ` -> \` (only unescaped backticks)
    .replace(/(?<!\\)\$\{/g, "\\${")  // ${ -> \${ (only unescaped template expressions)
    .replace(/(?<!\\)\\'/g, "\\\\'")  // \' -> \\' (but not \\')
    .replace(/(?<!\\)\\n/g, "\\\\n")  // \n -> \\n (but not \\n)
    .replace(/(?<!\\)\\r/g, "\\\\r")  // \r -> \\r (but not \\r)
    .replace(/(?<!\\)\\t/g, "\\\\t"); // \t -> \\t (but not \\t)
}

// Create the TypeScript file content
// Note: body.html and app.js already have proper escapes from extraction
const tsContent = `/**
 * AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY
 *
 * This file is generated by scripts/build-frontend.mjs
 * Edit the source files in src/frontend/ instead:
 * - styles.css
 * - body.html
 * - app.js
 *
 * Then run: npm run build:frontend
 */

export function getHtml(nonce: string): string {
  return \`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genre Genie - Organise Your Spotify by Genre</title>
  <meta name="description" content="Automatically sort your Spotify liked songs into genre-based playlists with one click. Free, open source, and privacy-focused.">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style nonce="\${nonce}">
${escapeCss(css)}
  </style>
</head>
<body>
${bodyHtml}
  <script nonce="\${nonce}">
${escapeJs(js)}
  </script>
</body>
</html>\`;
}
`;

// Ensure generated directory exists
mkdirSync(generatedDir, { recursive: true });

// Write the generated file
writeFileSync(join(generatedDir, 'frontend.ts'), tsContent);

console.log('Generated src/generated/frontend.ts');
console.log(`  CSS: ${css.split('\n').length} lines`);
console.log(`  HTML: ${bodyHtml.split('\n').length} lines`);
console.log(`  JS: ${js.split('\n').length} lines`);
