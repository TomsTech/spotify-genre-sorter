/**
 * AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY
 *
 * This file is generated by scripts/build-frontend.mjs
 * Edit the source files in src/frontend/ instead:
 * - styles.css
 * - body.html
 * - app.js
 *
 * Then run: npm run build:frontend
 */

export function getHtml(): string {
  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genre Genie - Organise Your Spotify by Genre</title>
  <meta name="description" content="Automatically sort your Spotify liked songs into genre-based playlists with one click. Free, open source, and privacy-focused.">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <style>
    :root {
      --bg: #0a0a0a;
      --surface: #141414;
      --surface-2: #1e1e1e;
      --border: #2a2a2a;
      --text: #fafafa;
      --text-muted: #888;
      --accent: #1DB954;
      --accent-hover: #1ed760;
      --danger: #e74c3c;
      --swedish-blue: #006AA7;
      --swedish-yellow: #FECC00;
    }

    /* Light mode theme - WCAG AA compliant */
    body.light-mode {
      --bg: #f5f5f5;
      --surface: #ffffff;
      --surface-2: #e9ecef;
      --border: #ced4da;
      --text: #1a1a1a;
      --text-muted: #495057;
    }

    /* Light mode specific overrides for accessibility */
    body.light-mode .stat {
      border: 1px solid var(--border);
    }

    body.light-mode .genre-item {
      border: 1px solid var(--border);
    }

    body.light-mode .genre-count {
      border: 1px solid var(--border);
      color: var(--text);
    }

    body.light-mode .btn-ghost {
      color: var(--text);
    }

    body.light-mode .btn-ghost:hover {
      background: var(--surface-2);
    }

    body.light-mode .btn-secondary {
      background: var(--surface);
    }

    body.light-mode .search-input {
      border: 2px solid var(--border);
    }

    body.light-mode .search-input:focus {
      border-color: var(--accent);
    }

    body.light-mode .template-settings {
      border: 1px solid var(--border);
    }

    body.light-mode .hidden-toolbar {
      border: 1px solid var(--border);
    }

    body.light-mode .stats-dashboard {
      border: 1px solid var(--border);
    }

    body.light-mode .deploy-widget {
      border: 1px solid var(--border);
      background: var(--surface);
    }

    body.light-mode .heidi-badge {
      border: 1px solid var(--border);
      background: var(--surface);
    }

    body.light-mode .user-counter {
      border: 1px solid var(--border);
    }

    body.light-mode .hof-entry {
      border: 1px solid var(--border);
    }

    body.light-mode .loading-stat {
      border: 1px solid var(--border);
    }

    body.light-mode .live-genre-card {
      border: 1px solid var(--border);
    }

    body.light-mode .progress-bar,
    body.light-mode .progress-bar-full {
      border: 1px solid var(--border);
    }

    body.light-mode .modal {
      background: var(--surface);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }

    body.light-mode .keyboard-help-panel {
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }

    body.light-mode .changelog-panel {
      background: var(--surface);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
    }

    body.light-mode .stat-box {
      border: 1px solid var(--border);
    }

    body.light-mode .genre-bar-track,
    body.light-mode .genre-bar-container {
      border: 1px solid var(--border);
    }

    body.light-mode .durry-btn {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    body.swedish-mode {
      --accent: #006AA7;
      --accent-hover: #0077b6;
      --bg: #001428;
      --surface: #002244;
      --surface-2: #003366;
      --border: #004488;
    }

    /* Swedish mode in light theme */
    body.swedish-mode.light-mode {
      --bg: #f0f4f8;
      --surface: #ffffff;
      --surface-2: #e8f0f8;
      --border: #b8d4e8;
    }

    body.swedish-mode .stat-value {
      background: linear-gradient(135deg, var(--swedish-blue), var(--swedish-yellow));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    body.swedish-mode .btn-primary {
      background: linear-gradient(135deg, var(--swedish-blue), var(--swedish-yellow));
    }

    body.swedish-mode header h1 svg {
      fill: url(#swedish-grad);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.6;
      transition: all 0.3s ease;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 3rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      border-radius: 6px;
      border: none;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--accent);
      color: #000;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--surface-2);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      color: var(--text);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat {
      background: var(--surface-2);
      padding: 1rem;
      border-radius: 6px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .truncation-warning {
      background: rgba(255, 193, 7, 0.15);
      border: 1px solid rgba(255, 193, 7, 0.4);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.85rem;
      color: var(--text);
      text-align: center;
    }

    body.light-mode .truncation-warning {
      background: rgba(255, 193, 7, 0.2);
    }

    .cache-status {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-bottom: 1rem;
      font-size: 0.75rem;
    }

    .cache-info {
      color: var(--text-muted);
    }

    .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.7rem;
    }

    body.swedish-mode .cache-status .btn {
      background: var(--swedish-blue);
    }

    .genre-list {
      display: grid;
      gap: 0.5rem;
      max-height: 500px;
      overflow-y: auto;
    }

    .genre-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: var(--surface-2);
      border-radius: 6px;
      transition: background 0.15s ease;
    }

    .genre-item:hover {
      background: var(--border);
    }

    .genre-checkbox {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .genre-name {
      flex: 1;
      font-size: 0.9rem;
    }

    .genre-count {
      font-size: 0.8rem;
      color: var(--text-muted);
      background: var(--surface);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }

    .genre-create {
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .genre-item:hover .genre-create,
    .genre-item:hover .genre-hide {
      opacity: 1;
    }

    .genre-hide {
      opacity: 0;
      transition: opacity 0.15s ease;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    .genre-item.hidden {
      opacity: 0.5;
      background: var(--surface);
    }

    .genre-item.hidden .genre-name {
      text-decoration: line-through;
    }

    /* Hidden genres toolbar */
    .hidden-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: var(--surface);
      border-radius: 6px;
      border: 1px solid var(--border);
      align-items: center;
    }

    .hidden-toolbar label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .hidden-count {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-left: auto;
    }

    .actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    /* Playlist Template Settings */
    .template-settings {
      margin-bottom: 1rem;
      padding: 1rem;
      background: var(--surface);
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .template-settings label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .template-input-row {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .template-input-row input {
      flex: 1;
    }

    .template-preview {
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .template-preview span {
      color: var(--accent);
      font-weight: 500;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      color: var(--text-muted);
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-sub {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
      opacity: 0.7;
    }

    /* Progressive loading progress bar */
    .progress-container {
      width: 100%;
      max-width: 300px;
      margin-top: 1rem;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    /* Modal dialog styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.2s ease;
    }

    .modal {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      max-width: 400px;
      width: 90%;
      animation: slideUp 0.3s ease;
    }

    .modal h3 {
      margin: 0 0 1rem;
      color: var(--text);
    }

    .modal p {
      margin: 0 0 1rem;
      color: var(--text);
    }

    .modal-actions {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    /* Playlist Customize Modal */
    .playlist-customize-modal {
      max-width: 500px;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text);
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border);
      border-radius: 6px;
      background: var(--surface);
      color: var(--text);
      font-family: inherit;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .playlist-preview {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      background: var(--surface-2);
      border-radius: 8px;
      margin: 1rem 0;
    }

    .preview-icon {
      font-size: 2.5rem;
      line-height: 1;
    }

    .preview-info {
      flex: 1;
    }

    .preview-tracks {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
    }

    .preview-hint {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .char-count {
      text-align: right;
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .error {
      background: rgba(231, 76, 60, 0.1);
      border: 1px solid var(--danger);
      color: var(--danger);
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      text-align: center;
    }

    .error strong {
      display: block;
      margin-bottom: 0.5rem;
    }

    .error p {
      margin: 0.5rem 0;
    }

    .error-detail {
      font-size: 0.8rem;
      opacity: 0.8;
      font-family: monospace;
    }

    .success {
      background: rgba(29, 185, 84, 0.1);
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .welcome {
      text-align: center;
      padding: 2rem 2rem;
      max-width: 500px;
      margin: 0 auto;
    }

    .welcome h2 {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .welcome p {
      color: var(--text-muted);
      margin-bottom: 2rem;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .results {
      margin-top: 1rem;
    }

    .result-item {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-success {
      color: var(--accent);
    }

    .result-error {
      color: var(--danger);
    }

    .result-skipped {
      color: var(--text-muted);
      font-style: italic;
    }

    /* Heidi Easter Egg Badge */
    .heidi-badge {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.7rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 100;
      opacity: 0.6;
    }

    .heidi-badge:hover {
      opacity: 1;
      transform: scale(1.05);
      border-color: var(--swedish-yellow);
      box-shadow: 0 0 20px rgba(254, 204, 0, 0.2);
    }

    .heidi-badge svg {
      width: 20px;
      height: 20px;
    }

    .heidi-badge .heidi-text {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    .heidi-badge .heart {
      color: #e74c3c;
      animation: pulse 1.5s ease infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    body.swedish-mode .heidi-badge {
      background: linear-gradient(135deg, var(--swedish-blue), var(--swedish-yellow));
      color: #fff;
      opacity: 1;
    }

    /* Swedish mode decorations - Three Crowns (Tre Kronor) */
    .swedish-crowns {
      display: none;
      gap: 0.25rem;
      margin-left: 0.5rem;
      font-size: 1.2rem;
    }

    body.swedish-mode .swedish-crowns {
      display: flex;
    }

    .swedish-crowns .crown {
      animation: float 2s ease-in-out infinite;
    }

    .swedish-crowns .crown:nth-child(1) {
      animation-delay: 0s;
    }

    .swedish-crowns .crown:nth-child(2) {
      animation-delay: 0.3s;
      font-size: 1.4rem;
      margin-top: -3px;
    }

    .swedish-crowns .crown:nth-child(3) {
      animation-delay: 0.6s;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }

    .viking-ship {
      display: none;
      position: fixed;
      bottom: 60px;
      left: -100px;
      font-size: 2rem;
      animation: sail 15s linear infinite;
    }

    body.swedish-mode .viking-ship {
      display: block;
    }

    @keyframes sail {
      0% { left: -100px; }
      100% { left: calc(100% + 100px); }
    }

    /* Fika reminder popup */
    .fika-reminder {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      animation: fadeIn 0.3s ease;
    }

    .fika-content {
      background: linear-gradient(135deg, #006AA7, #004d7a);
      color: white;
      padding: 2rem;
      border-radius: 16px;
      text-align: center;
      animation: bounceIn 0.5s ease;
    }

    .fika-emoji {
      font-size: 3rem;
      display: block;
      margin-bottom: 1rem;
    }

    .fika-content p {
      margin: 0.5rem 0;
      font-size: 1.2rem;
    }

    .fika-content button {
      margin-top: 1rem;
      background: #FECC00;
      color: #006AA7;
      font-weight: 600;
    }

    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Midsommar mode (June) */
    body.swedish-mode.midsommar::before {
      content: 'ðŸŒ¸ðŸŒ¼ðŸŒ·ðŸŒ»ðŸŒº';
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.5rem;
      letter-spacing: 0.5rem;
      animation: float 3s ease-in-out infinite;
      z-index: 1;
    }

    @keyframes float {
      0%, 100% { transform: translateX(-50%) translateY(0); }
      50% { transform: translateX(-50%) translateY(-10px); }
    }

    /* User counter */
    .user-counter {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--surface-2);
      border-radius: 20px;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 1.5rem;
    }

    .user-counter .count {
      color: var(--accent);
      font-weight: 700;
    }

    /* Swedish mode user counter */
    body.swedish-mode .user-counter {
      background: linear-gradient(135deg, var(--swedish-blue), #004d7a);
      color: #fff;
    }

    body.swedish-mode .user-counter .count {
      color: var(--swedish-yellow);
    }

    /* Swedish mode Hall of Fame */
    body.swedish-mode .hall-of-fame h3 {
      color: var(--swedish-yellow);
    }

    body.swedish-mode .hof-entry {
      background: linear-gradient(135deg, var(--swedish-blue), #004d7a);
      color: #fff;
    }

    /* Deployment Monitor Widget */
    .deploy-widget {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.5rem 0.75rem;
      font-size: 0.7rem;
      color: var(--text-muted);
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      opacity: 0.8;
      transition: opacity 0.2s, transform 0.2s;
      cursor: pointer;
    }

    .deploy-widget:hover {
      opacity: 1;
      transform: translateY(-2px);
    }

    .deploy-widget.deploying {
      border-color: var(--accent);
      animation: pulse 2s ease-in-out infinite;
    }

    .deploy-widget.success {
      border-color: var(--success);
    }

    .deploy-widget.failure {
      border-color: var(--danger);
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(29, 185, 84, 0.4); }
      50% { box-shadow: 0 0 0 4px rgba(29, 185, 84, 0); }
    }

    .deploy-widget .avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
    }

    .deploy-widget .spinner-small {
      width: 14px;
      height: 14px;
      border: 2px solid var(--surface-2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .deploy-widget .step {
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .deploy-refresh-prompt {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--surface);
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 1.5rem;
      text-align: center;
      z-index: 2000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .deploy-refresh-prompt h3 {
      margin-bottom: 0.5rem;
      color: var(--accent);
    }

    .deploy-refresh-prompt p {
      margin-bottom: 1rem;
      color: var(--text-muted);
    }

    .deploy-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1999;
    }

    /* Hall of Fame */
    .hall-of-fame {
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .hall-of-fame h3 {
      font-size: 0.9rem;
      margin-bottom: 1rem;
      color: var(--text-muted);
    }

    .hof-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .hof-entry {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.5rem;
      background: var(--surface-2);
      border-radius: 4px;
      font-size: 0.7rem;
    }

    .hof-entry .position {
      color: var(--swedish-yellow);
      font-weight: 700;
    }

    /* Donation button - in sidebar */
    .sidebar-donate-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, #8B4513, #D2691E);
      border: none;
      border-radius: 8px;
      font-size: 0.85rem;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      margin-top: auto;
    }

    .sidebar-donate-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 0 15px rgba(210, 105, 30, 0.4);
    }

    .sidebar-donate-btn .icon {
      animation: smoke 2s ease-in-out infinite;
    }

    @keyframes smoke {
      0%, 100% { opacity: 0.5; transform: translateY(0); }
      50% { opacity: 1; transform: translateY(-2px); }
    }

    /* Swedish mode snus styling */
    body.swedish-mode .sidebar-donate-btn {
      background: linear-gradient(135deg, var(--swedish-blue), #004d7a);
    }

    body.swedish-mode .sidebar-donate-btn:hover {
      box-shadow: 0 0 15px rgba(0, 106, 167, 0.4);
    }

    /* Bryan tribute text */
    .bryan-text {
      font-size: 0.5rem;
      opacity: 0.7;
      font-style: italic;
      vertical-align: super;
      margin-left: 0.2rem;
    }

    /* Floating Genie Mascot */
    .genie-mascot {
      position: fixed;
      bottom: 6rem;
      right: 1.5rem;
      font-size: 2.5rem;
      cursor: pointer;
      z-index: 90;
      animation: genieFloat 4s ease-in-out infinite, genieWander 20s ease-in-out infinite;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
      transition: transform 0.3s ease;
    }

    .genie-mascot:hover {
      animation-play-state: paused;
      transform: scale(1.2);
    }

    @keyframes genieFloat {
      0%, 100% { transform: translateY(0) rotate(-5deg); }
      50% { transform: translateY(-15px) rotate(5deg); }
    }

    @keyframes genieWander {
      0%, 100% { right: 1.5rem; bottom: 6rem; }
      25% { right: 3rem; bottom: 8rem; }
      50% { right: 2rem; bottom: 5rem; }
      75% { right: 4rem; bottom: 7rem; }
    }

    body.swedish-mode .genie-mascot {
      display: none;
    }

    /* Swedish Viking replaces Genie */
    body.swedish-mode .viking-ship {
      display: block;
    }

    /* Footer badges */
    .footer-badges {
      display: flex;
      gap: 0.5rem;
      margin-top: 2rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .footer-badges a {
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .footer-badges a:hover {
      opacity: 1;
    }

    /* Stats Dashboard */
    .stats-dashboard {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--surface);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .stats-toggle {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .stats-toggle h3 {
      margin: 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .stats-content {
      margin-top: 1rem;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .stats-section {
      background: var(--surface-2);
      padding: 0.75rem;
      border-radius: 6px;
    }

    .stats-section h4 {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin: 0 0 0.5rem 0;
    }

    .top-genres-list {
      display: flex;
      flex-direction: column;
      gap: 0.375rem;
    }

    .genre-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .genre-bar-name {
      font-size: 0.75rem;
      width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .genre-bar-track {
      flex: 1;
      height: 16px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }

    .genre-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .genre-bar-count {
      font-size: 0.7rem;
      color: var(--text-muted);
      width: 35px;
      text-align: right;
    }

    .diversity-meter {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
      margin: 0.5rem 0;
    }

    .diversity-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71);
      border-radius: 4px;
    }

    .diversity-label {
      font-size: 0.85rem;
      text-align: center;
    }

    .diversity-score {
      font-size: 1.5rem;
      font-weight: bold;
      text-align: center;
      color: var(--accent);
    }

    .avg-stat {
      text-align: center;
    }

    .avg-stat .big-number {
      font-size: 2rem;
      font-weight: bold;
      color: var(--accent);
    }

    .avg-stat .label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    /* Toolbar Row */
    .toolbar-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
      justify-content: center;
    }

    /* Stats Dashboard - genre bars */
    .genre-bars {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .genre-bar-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .genre-bar-row .genre-bar-name {
      font-size: 0.75rem;
      width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .genre-bar-container {
      flex: 1;
      height: 16px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
    }

    .genre-bar-container .genre-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-hover));
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .genre-bar-row .genre-bar-count {
      font-size: 0.7rem;
      color: var(--text-muted);
      width: 35px;
      text-align: right;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .stat-box {
      background: var(--surface-2);
      padding: 1rem;
      border-radius: 6px;
      text-align: center;
    }

    .stat-box-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent);
    }

    .stat-box-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .diversity-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
    }

    .diversity-info .diversity-score {
      font-size: 1.25rem;
    }

    .diversity-info .diversity-label {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
      header {
        position: sticky;
        top: 0;
        z-index: 100;
        padding: 0.75rem 1rem;
        backdrop-filter: blur(10px);
        background: rgba(var(--bg), 0.95);
      }

      header h1 {
        font-size: 1.25rem;
      }

      .user-info {
        gap: 0.5rem;
      }

      .user-info span {
        display: none;
      }

      .user-info .avatar {
        width: 32px;
        height: 32px;
      }

      main {
        padding: 0.75rem;
      }

      .stats {
        flex-direction: column;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }

      .stat {
        padding: 0.75rem;
      }

      .stat-label {
        font-size: 0.7rem;
      }

      .stat-value {
        font-size: 1.25rem;
      }

      .card {
        padding: 1rem;
      }

      .card-title {
        font-size: 1.25rem;
      }

      .genre-list {
        max-height: 60vh;
        gap: 0.375rem;
      }

      .genre-item {
        padding: 0.875rem 0.75rem;
        min-height: 48px;
        flex-wrap: wrap;
      }

      .genre-checkbox {
        width: 22px;
        height: 22px;
      }

      .genre-name {
        font-size: 0.85rem;
        flex: 1 1 auto;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .genre-count {
        font-size: 0.7rem;
        padding: 0.2rem 0.4rem;
      }

      .genre-hide,
      .genre-create {
        opacity: 1;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .btn {
        min-height: 44px;
        min-width: 44px;
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
      }

      .btn-sm {
        min-height: 40px;
        padding: 0.5rem 0.75rem;
      }

      .actions {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--surface);
        padding: 1rem;
        margin: 1rem -1rem -1rem;
        border-radius: 0;
        border-top: 1px solid var(--border);
        flex-wrap: wrap;
        z-index: 50;
      }

      .actions .btn {
        flex: 1;
        min-width: 100px;
      }

      .template-settings {
        padding: 0.75rem;
      }

      .template-input-row {
        flex-direction: column;
        gap: 0.5rem;
      }

      .template-input-row input {
        width: 100%;
      }

      .hidden-toolbar {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
      }

      .hidden-toolbar label {
        justify-content: center;
      }

      .hidden-toolbar button {
        width: 100%;
      }

      .hidden-count {
        margin-left: 0;
        text-align: center;
      }

      .search-input {
        font-size: 16px;
        min-height: 44px;
      }

      .welcome {
        padding: 1.5rem 1rem;
      }

      .welcome h2 {
        font-size: 1.5rem;
      }

      .welcome p {
        font-size: 0.9rem;
      }

      .cache-status {
        flex-direction: column;
        gap: 0.5rem;
        align-items: stretch;
      }

      .deploy-widget {
        top: auto;
        bottom: 60px;
        right: 10px;
        font-size: 0.7rem;
        padding: 0.4rem 0.6rem;
      }

      .heidi-badge {
        bottom: 10px;
        right: 10px;
        font-size: 0.65rem;
        padding: 0.35rem 0.6rem;
      }

      .result-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .stats-content {
        grid-template-columns: 1fr;
      }

      .genre-bar-name {
        width: 80px;
        font-size: 0.7rem;
      }
    }

    @media (max-width: 400px) {
      header h1 {
        font-size: 1rem;
      }

      .btn {
        padding: 0.625rem 0.75rem;
        font-size: 0.85rem;
      }

      .genre-item {
        padding: 0.75rem 0.5rem;
      }

      .stat-value {
        font-size: 1.1rem;
      }
    }

    /* Changelog Timeline */
    .changelog-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .changelog-overlay.visible {
      opacity: 1;
    }

    .changelog-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      z-index: 1001;
      opacity: 0;
      transition: all 0.3s ease;
    }

    .changelog-panel.visible {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }

    .changelog-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }

    .changelog-header h3 {
      margin: 0;
      font-size: 1.1rem;
      color: var(--text);
    }

    .changelog-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .changelog-close:hover {
      color: var(--text);
    }

    .changelog-timeline {
      overflow-y: auto;
      padding: 1rem 1.25rem;
      flex: 1;
    }

    .changelog-item {
      display: flex;
      gap: 1rem;
      position: relative;
      padding-bottom: 1.25rem;
    }

    .changelog-item:last-child {
      padding-bottom: 0;
    }

    .changelog-item:not(:last-child)::before {
      content: '';
      position: absolute;
      left: 7px;
      top: 18px;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }

    .changelog-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--border);
      flex-shrink: 0;
      margin-top: 3px;
    }

    .changelog-item.current .changelog-dot {
      background: var(--spotify-green);
      box-shadow: 0 0 8px var(--spotify-green);
    }

    .changelog-content {
      flex: 1;
    }

    .changelog-version {
      font-weight: 600;
      color: var(--text);
      font-size: 0.95rem;
    }

    .changelog-item.current .changelog-version {
      color: var(--spotify-green);
    }

    .changelog-date {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .changelog-changes {
      margin: 0;
      padding-left: 1.2rem;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .changelog-changes li {
      margin-bottom: 0.25rem;
    }

    .changelog-footer {
      padding: 0.75rem 1.25rem;
      border-top: 1px solid var(--border);
      text-align: center;
    }

    .changelog-footer a {
      color: var(--spotify-green);
      text-decoration: none;
      font-size: 0.9rem;
    }

    .changelog-footer a:hover {
      text-decoration: underline;
    }

    /* Progressive Loading */
    .progressive-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1.5rem;
      padding: 2rem;
    }

    .progress-header {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .progress-message {
      color: var(--text);
      font-size: 1.1rem;
    }

    .progress-container {
      width: 100%;
      max-width: 400px;
    }

    .progress-bar {
      height: 8px;
      background: var(--border);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--spotify-green), #1ed760);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .progress-text {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    .partial-genres-container {
      width: 100%;
      max-width: 600px;
    }

    .partial-genres-preview {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      animation: fadeIn 0.3s ease;
    }

    .preview-label {
      display: block;
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
    }

    .preview-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .preview-tag {
      background: var(--bg);
      color: var(--text);
      padding: 0.35rem 0.7rem;
      border-radius: 20px;
      font-size: 0.8rem;
      animation: slideIn 0.3s ease;
    }

    .preview-more {
      color: var(--text-muted);
      font-size: 0.8rem;
      padding: 0.35rem 0.5rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    /* Theme Toggle in Header */
    #header-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .theme-toggle-btn {
      font-size: 1.2rem;
      padding: 0.5rem;
      border-radius: 8px;
      transition: transform 0.2s ease, background 0.2s ease;
      flex-shrink: 0;
    }

    .theme-toggle-btn:hover {
      transform: scale(1.1);
      background: var(--border);
    }

    /* Enhanced Loading UX - Full Page Interactive */
    .progressive-loading-full {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }

    /* Album Art Carousel */
    .album-art-carousel {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1rem;
      margin-bottom: 2rem;
      height: 120px;
      perspective: 1000px;
    }

    .album-art-item {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      transform: scale(0.8) rotateY(-15deg);
    }

    .album-art-item.visible {
      opacity: 1;
      transform: scale(1) rotateY(0deg);
    }

    .album-art-item.center {
      width: 120px;
      height: 120px;
      box-shadow: 0 8px 25px rgba(29, 185, 84, 0.4);
      z-index: 2;
    }

    .album-art-item.left {
      transform: scale(0.85) rotateY(15deg) translateX(-10px);
    }

    .album-art-item.right {
      transform: scale(0.85) rotateY(-15deg) translateX(10px);
    }

    .album-art-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .album-art-item.placeholder {
      background: var(--surface-2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
    }

    /* Animated counter effect */
    .loading-stat-value.counting {
      animation: countPulse 0.3s ease;
    }

    @keyframes countPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); color: #1ed760; }
      100% { transform: scale(1); }
    }

    /* Live bar chart */
    .live-bar-chart {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .live-bar-chart h4 {
      margin-bottom: 1rem;
      font-size: 0.95rem;
      color: var(--text-muted);
    }

    .bar-chart-item {
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
      gap: 0.5rem;
    }

    .bar-chart-label {
      width: 120px;
      font-size: 0.8rem;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .bar-chart-bar-container {
      flex: 1;
      height: 20px;
      background: var(--surface-2);
      border-radius: 4px;
      overflow: hidden;
    }

    .bar-chart-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #1ed760);
      border-radius: 4px;
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 2px;
    }

    .bar-chart-count {
      width: 40px;
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: right;
    }

    .loading-header {
      text-align: center;
      margin-bottom: 2rem;
    }

    .loading-header h2 {
      font-size: 1.8rem;
      margin-bottom: 0.5rem;
      color: var(--text);
    }

    .loading-subtitle {
      color: var(--text-muted);
      font-size: 1rem;
    }

    .loading-stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .loading-stat {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      text-align: center;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }

    .loading-stat:hover {
      transform: translateY(-2px);
      border-color: var(--accent);
    }

    .loading-stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      transition: all 0.3s ease;
    }

    .loading-stat-label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.25rem;
    }

    .progress-container-full {
      margin-bottom: 2rem;
    }

    .progress-bar-full {
      height: 12px;
      background: var(--surface);
      border-radius: 6px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .progress-fill-full {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #1ed760);
      border-radius: 6px;
      transition: width 0.5s ease;
      box-shadow: 0 0 10px rgba(29, 185, 84, 0.4);
    }

    .progress-detail {
      text-align: center;
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    .live-genres-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
    }

    .live-genres-section h3 {
      margin-bottom: 1rem;
      font-size: 1.1rem;
      color: var(--text);
    }

    .live-genres-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.75rem;
    }

    .live-genre-card {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.3s ease;
      animation: fadeInUp 0.3s ease forwards;
    }

    .live-genre-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .live-genre-emoji {
      font-size: 1.4rem;
      flex-shrink: 0;
    }

    .live-genre-name {
      flex: 1;
      font-size: 0.85rem;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .live-genre-count {
      font-size: 0.75rem;
      color: var(--accent);
      font-weight: 600;
      background: var(--surface);
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Mobile responsive for loading stats */
    @media (max-width: 600px) {
      .loading-stats-row {
        grid-template-columns: repeat(2, 1fr);
      }

      .loading-stat-value {
        font-size: 1.5rem;
      }

      .live-genres-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .live-genre-card {
        padding: 0.5rem;
      }

      .live-genre-emoji {
        font-size: 1.2rem;
      }

      .live-genre-name {
        font-size: 0.75rem;
      }
    }

    /* === Keyboard Shortcuts Help === */
    .keyboard-help-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1100;
      animation: fadeIn 0.2s ease;
    }

    .keyboard-help-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .keyboard-help-panel h3 {
      margin-bottom: 1.5rem;
      font-size: 1.25rem;
      text-align: center;
    }

    .shortcuts-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .shortcut-item {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .shortcut-item kbd {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.25rem 0.5rem;
      font-family: monospace;
      font-size: 0.85rem;
      min-width: 80px;
      text-align: center;
      color: var(--accent);
    }

    .shortcut-item span {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .keyboard-help-panel button {
      width: 100%;
      justify-content: center;
    }

    /* === Accessibility: Screen Reader Only === */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* === Focus Visible Styles === */
    :focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .btn:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(29, 185, 84, 0.2);
    }

    .genre-checkbox:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .search-input:focus-visible {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.15);
    }

    /* Keyboard hint in search */
    .search-input::placeholder {
      opacity: 0.6;
    }

    /* Skip link for keyboard users */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--accent);
      color: #000;
      padding: 0.5rem 1rem;
      z-index: 9999;
      border-radius: 0 0 8px 0;
      text-decoration: none;
      font-weight: 500;
    }

    .skip-link:focus {
      top: 0;
    }

    /* =========================================
       SIDEBAR LAYOUT
       ========================================= */

    .app-wrapper {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .app-header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 1600px;
      margin: 0 auto;
      padding-left: 280px; /* Account for fixed sidebar */
    }

    .header-content h1 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0;
      font-size: 1.5rem;
    }

    .genie-sparkle {
      animation: sparkle 2s ease-in-out infinite;
    }

    @keyframes sparkle {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    .swedish-crowns {
      display: none;
      gap: 0.25rem;
      margin-left: 0.5rem;
    }

    body.swedish-mode .swedish-crowns {
      display: flex;
    }

    body.swedish-mode .genie-sparkle {
      display: none;
    }

    .swedish-crowns .crown {
      font-size: 0.9rem;
      animation: crownBounce 1.5s ease-in-out infinite;
    }

    .swedish-crowns .crown:nth-child(2) {
      animation-delay: 0.2s;
    }

    .swedish-crowns .crown:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes crownBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    .content-wrapper {
      display: flex;
      flex: 1;
      width: 100%;
      justify-content: center;
    }

    /* === Sidebar === */
    .sidebar {
      width: 280px;
      min-width: 280px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      overflow-y: auto;
      height: calc(100vh - 80px);
      position: fixed;
      left: 0;
      top: 80px;
      z-index: 50;
    }

    .sidebar-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .sidebar-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: help;
    }

    .cache-hint {
      font-size: 0.7rem;
      opacity: 0.5;
      margin-left: auto;
    }

    .sidebar-loading {
      color: var(--text-muted);
      font-size: 0.85rem;
      padding: 0.5rem;
    }

    /* === Pioneer/User List Items === */
    .user-list-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .user-list-item:hover {
      background: var(--surface-2);
    }

    .user-list-item .position {
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--accent);
      min-width: 24px;
    }

    .user-list-item .position.gold {
      color: #FFD700;
    }

    .user-list-item .position.silver {
      color: #C0C0C0;
    }

    .user-list-item .position.bronze {
      color: #CD7F32;
    }

    .user-list-item .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--surface-2);
    }

    .user-list-item .user-avatar-placeholder {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--surface-2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .user-list-item .user-name {
      flex: 1;
      font-size: 0.9rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-list-item .regalia {
      font-size: 0.85rem;
    }

    /* Pioneer regalia badges */
    .pioneer-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.75rem;
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #000;
      font-weight: 600;
    }

    .pioneer-badge.first {
      background: linear-gradient(135deg, #FFD700, #FF6B00);
      animation: pulseGlow 2s ease-in-out infinite;
    }

    @keyframes pulseGlow {
      0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
      50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.8); }
    }

    /* Staggered fade-in animation for sidebar items */
    @keyframes sidebarItemFadeIn {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .user-list-item.animate-in,
    .playlist-list-item.animate-in {
      animation: sidebarItemFadeIn 0.3s ease-out forwards;
      opacity: 0;
    }

    /* === Recent Playlists === */
    .playlist-list-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      border-radius: 8px;
      transition: background 0.2s;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
    }

    .playlist-list-item:hover {
      background: var(--surface-2);
    }

    .playlist-list-item .playlist-icon {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .playlist-list-item .playlist-info {
      flex: 1;
      min-width: 0;
    }

    .playlist-list-item .playlist-name {
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .playlist-list-item .playlist-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .playlist-list-item .playlist-creator {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .playlist-list-item .creator-avatar {
      width: 14px;
      height: 14px;
      border-radius: 50%;
    }

    /* === Sidebar Toggle (Mobile) === */
    .sidebar-toggle {
      display: none;
      position: fixed;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      background: var(--surface);
      border: 1px solid var(--border);
      border-left: none;
      border-radius: 0 8px 8px 0;
      padding: 0.75rem 0.5rem;
      cursor: pointer;
      z-index: 99;
      transition: background 0.2s;
    }

    .sidebar-toggle:hover {
      background: var(--surface-2);
    }

    .sidebar-toggle .toggle-icon {
      font-size: 0.9rem;
      transition: transform 0.3s;
    }

    .sidebar.collapsed + .sidebar-toggle .toggle-icon {
      transform: rotate(180deg);
    }

    /* === Main Content with Sidebar === */
    .main-content {
      flex: 1;
      padding: 1.5rem;
      padding-left: calc(280px + 1.5rem); /* Account for fixed sidebar */
      min-width: 0;
      max-width: 1000px;
      margin: 0 auto;
    }

    /* === Scoreboard Button === */
    .sidebar-scoreboard-btn {
      width: 100%;
      justify-content: center;
      margin-top: 1rem;
      margin-bottom: 0;
    }

    /* === Scoreboard Modal === */
    .scoreboard-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1100;
      padding: 1rem;
    }

    .scoreboard-modal.active {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    .scoreboard-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .scoreboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .scoreboard-header h2 {
      margin: 0;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .scoreboard-tabs {
      display: flex;
      gap: 0.5rem;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
    }

    .scoreboard-tab {
      padding: 0.5rem 1rem;
      border-radius: 8px;
      background: var(--surface-2);
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-muted);
      white-space: nowrap;
      transition: all 0.2s;
    }

    .scoreboard-tab:hover {
      background: var(--surface-2);
      color: var(--text);
    }

    .scoreboard-tab.active {
      background: var(--accent);
      color: #000;
    }

    .scoreboard-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .scoreboard-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .scoreboard-entry {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      background: var(--surface-2);
    }

    .scoreboard-entry .rank {
      font-weight: 700;
      font-size: 1rem;
      min-width: 32px;
      text-align: center;
    }

    .scoreboard-entry .rank.gold { color: #FFD700; }
    .scoreboard-entry .rank.silver { color: #C0C0C0; }
    .scoreboard-entry .rank.bronze { color: #CD7F32; }

    .scoreboard-entry .entry-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      background: var(--surface);
    }

    .scoreboard-entry .entry-info {
      flex: 1;
    }

    .scoreboard-entry .entry-name {
      font-weight: 500;
    }

    .scoreboard-entry .entry-count {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent);
    }

    .scoreboard-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* === Responsive Sidebar === */
    @media (max-width: 1024px) {
      .sidebar {
        position: fixed;
        left: 0;
        top: 80px;
        bottom: 0;
        z-index: 98;
        transform: translateX(0);
        transition: transform 0.3s ease;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
      }

      .sidebar.collapsed {
        transform: translateX(-100%);
      }

      .sidebar-toggle {
        display: block;
      }

      .main-content {
        padding-left: 1.5rem;
        max-width: 100%;
      }

      .header-content {
        padding-left: 0;
      }
    }

    @media (max-width: 640px) {
      .app-header {
        padding: 0.75rem 1rem;
      }

      .header-content h1 {
        font-size: 1.25rem;
      }

      .sidebar {
        width: 260px;
        min-width: 260px;
        padding: 1rem;
      }

      .scoreboard-panel {
        border-radius: 12px;
      }

      .scoreboard-tabs {
        padding: 0.75rem 1rem;
      }
    }

    /* === Light Mode Sidebar Overrides === */
    body.light-mode .sidebar {
      background: #ffffff;
      border-right-color: #dee2e6;
    }

    body.light-mode .user-list-item:hover,
    body.light-mode .playlist-list-item:hover {
      background: #f1f3f4;
    }

    body.light-mode .sidebar-toggle {
      background: #ffffff;
      border-color: #dee2e6;
    }

    body.light-mode .sidebar-toggle:hover {
      background: #f1f3f4;
    }

    body.light-mode .scoreboard-entry {
      background: #f1f3f4;
    }

    body.light-mode .scoreboard-tab {
      background: #e9ecef;
      color: #495057;
    }

    body.light-mode .scoreboard-tab:hover {
      background: #dee2e6;
    }

    /* === Swedish Mode Sidebar === */
    body.swedish-mode .pioneer-badge {
      background: linear-gradient(135deg, #FECC00, #006AA7);
      color: #fff;
    }

    body.swedish-mode .user-list-item .position {
      color: #006AA7;
    }

    body.swedish-mode .scoreboard-tab.active {
      background: #006AA7;
      color: #FECC00;
    }

    /* =========================================
       ALBUM ART LOADING ANIMATION
       ========================================= */

    .playlist-loading-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      animation: fadeIn 0.3s ease;
    }

    .album-carousel {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
      perspective: 800px;
    }

    .album-art {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      object-fit: cover;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      animation: albumFlip 2s ease-in-out infinite;
      transform-style: preserve-3d;
    }

    .album-art:nth-child(1) { animation-delay: 0s; }
    .album-art:nth-child(2) { animation-delay: 0.2s; }
    .album-art:nth-child(3) { animation-delay: 0.4s; }
    .album-art:nth-child(4) { animation-delay: 0.6s; }
    .album-art:nth-child(5) { animation-delay: 0.8s; }

    @keyframes albumFlip {
      0%, 100% {
        transform: rotateY(0deg) scale(1);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      }
      25% {
        transform: rotateY(180deg) scale(1.1);
        box-shadow: 0 12px 32px rgba(29, 185, 84, 0.4);
      }
      50% {
        transform: rotateY(360deg) scale(1);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      }
    }

    .album-art.vinyl-mode {
      animation: vinylSpin 3s linear infinite;
      border-radius: 50%;
    }

    @keyframes vinylSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    @keyframes vinylFlip {
      0% {
        transform: rotateY(0deg) scale(1);
      }
      50% {
        transform: rotateY(180deg) scale(1.15);
        filter: brightness(1.2);
      }
      100% {
        transform: rotateY(360deg) scale(1);
      }
    }

    .loading-text {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 1rem;
      text-align: center;
      min-height: 2rem;
    }

    .loading-progress {
      width: 300px;
      max-width: 80%;
      height: 4px;
      background: var(--surface-2);
      border-radius: 2px;
      overflow: hidden;
    }

    .loading-progress-bar {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .loading-stats {
      margin-top: 1.5rem;
      display: flex;
      gap: 2rem;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .loading-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .loading-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }

    /* Celebration overlay */
    .celebration-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1300;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--accent);
      animation: confettiFall 3s ease-out forwards;
    }

    @keyframes confettiFall {
      0% {
        opacity: 1;
        transform: translateY(-100px) rotate(0deg);
      }
      100% {
        opacity: 0;
        transform: translateY(100vh) rotate(720deg);
      }
    }

    /* Responsive adjustments */
    @media (max-width: 640px) {
      .album-art {
        width: 60px;
        height: 60px;
      }

      .album-carousel {
        gap: 0.25rem;
      }

      .loading-text {
        font-size: 1rem;
      }

      .loading-stats {
        gap: 1rem;
      }
    }

    /* === Fireworks Celebration === */
    .fireworks-container {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 10000;
      overflow: hidden;
    }

    .firework {
      position: absolute;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      animation: fireworkExplode 1s ease-out forwards;
    }

    @keyframes fireworkExplode {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(0);
        opacity: 0;
      }
    }

    .firework-particle {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      animation: particleFly 1.2s ease-out forwards;
    }

    @keyframes particleFly {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      100% {
        opacity: 0;
      }
    }

    .celebration-text {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 3rem;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 0 20px rgba(29, 185, 84, 0.8), 0 0 40px rgba(29, 185, 84, 0.6);
      animation: celebrationPop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      z-index: 10001;
      pointer-events: none;
    }

    @keyframes celebrationPop {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 0;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.2);
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 1;
      }
    }

    .celebration-text.fade-out {
      animation: celebrationFade 0.5s ease-out forwards;
    }

    @keyframes celebrationFade {
      to {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
      }
    }

    /* === Playlist Customisation Modal === */
    .customise-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      padding: 1rem;
      animation: fadeIn 0.2s ease;
    }

    .customise-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    .customise-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .customise-header h3 {
      margin: 0;
      font-size: 1.2rem;
    }

    .customise-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
    }

    .customise-close:hover {
      color: var(--text);
    }

    .customise-body {
      padding: 1.5rem;
    }

    .customise-field {
      margin-bottom: 1.25rem;
    }

    .customise-field label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .customise-field input,
    .customise-field textarea {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .customise-field input:focus,
    .customise-field textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .customise-field textarea {
      min-height: 80px;
      resize: vertical;
    }

    .customise-field .field-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .customise-preview {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.25rem;
    }

    .customise-preview-title {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }

    .customise-preview-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 0.25rem;
    }

    .customise-preview-desc {
      font-size: 0.85rem;
      color: var(--text-muted);
      white-space: pre-wrap;
    }

    .customise-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }

    .customise-track-count {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--accent);
      color: #000;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* Customise button in genre card */
    .genre-customise {
      padding: 0.25rem 0.5rem;
      font-size: 0.9rem;
      opacity: 0.6;
      transition: opacity 0.2s;
    }

    .genre-customise:hover {
      opacity: 1;
    }

    /* Genre tags for merge modal */
    .genre-tag {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      background: var(--accent);
      color: #000;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <!-- Deployment Monitor Widget -->
  <div class="deploy-widget" id="deploy-widget" style="display: none;" onclick="showDeployDetails()">
    <span class="status-icon"></span>
    <span class="deploy-text">Checking...</span>
  </div>

  <!-- SVG Gradient Definition for Swedish mode -->
  <svg style="position:absolute;width:0;height:0;">
    <defs>
      <linearGradient id="swedish-grad" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" style="stop-color:#006AA7"/>
        <stop offset="50%" style="stop-color:#FECC00"/>
        <stop offset="100%" style="stop-color:#006AA7"/>
      </linearGradient>
    </defs>
  </svg>

  <!-- Viking ship Easter egg (only in Swedish mode) -->
  <div class="viking-ship" title="Vikingaskepp!">â›µ</div>

  <div class="app-wrapper">
    <header class="app-header">
      <div class="header-content">
        <h1>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.586 14.424a.622.622 0 01-.857.207c-2.348-1.435-5.304-1.76-8.785-.964a.622.622 0 01-.277-1.215c3.809-.87 7.076-.496 9.712 1.115.293.18.386.563.207.857zm1.223-2.722a.78.78 0 01-1.072.257c-2.687-1.652-6.785-2.131-9.965-1.166a.78.78 0 01-.973-.519.781.781 0 01.52-.972c3.632-1.102 8.147-.568 11.233 1.329a.78.78 0 01.257 1.071zm.105-2.835c-3.223-1.914-8.54-2.09-11.618-1.156a.935.935 0 11-.543-1.79c3.533-1.072 9.404-.865 13.115 1.338a.935.935 0 11-.954 1.608z"/>
          </svg>
          <span data-i18n="title">Genre Genie</span>
          <span class="genie-sparkle">âœ¨</span>
        </h1>
        <span class="swedish-crowns" title="Tre Kronor - Three Crowns of Sweden">
          <span class="crown">ðŸ‘‘</span>
          <span class="crown">ðŸ‘‘</span>
          <span class="crown">ðŸ‘‘</span>
        </span>
        <div id="header-actions"></div>
      </div>
    </header>

    <div class="content-wrapper">
      <!-- Left Sidebar -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-section">
          <h3 class="sidebar-title" title="Updates every 15 minutes to save API calls">ðŸ† <span data-i18n="pioneers">Pioneers</span> <span class="cache-hint">â±ï¸</span></h3>
          <div class="pioneers-list" id="pioneers-list">
            <div class="sidebar-loading">Loading...</div>
          </div>
        </div>

        <div class="sidebar-section">
          <h3 class="sidebar-title" title="Updates every 15 minutes to save API calls">ðŸ‘‹ <span data-i18n="newUsers">New Users</span> <span class="cache-hint">â±ï¸</span></h3>
          <div class="new-users-list" id="new-users-list">
            <div class="sidebar-loading">Loading...</div>
          </div>
        </div>

        <div class="sidebar-section">
          <h3 class="sidebar-title" title="Refreshes every 3 minutes">ðŸŽµ <span data-i18n="recentPlaylists">Recent Playlists</span> <span class="cache-hint">â±ï¸</span></h3>
          <div class="recent-playlists-list" id="recent-playlists-list">
            <div class="sidebar-loading">Loading...</div>
          </div>
        </div>

        <button class="btn btn-secondary sidebar-scoreboard-btn" onclick="showScoreboard()" title="Rankings update every hour">
          ðŸ“Š <span data-i18n="viewScoreboard">View Scoreboard</span>
        </button>

        <!-- Donation button moved to sidebar -->
        <a href="https://buymeacoffee.com/tomstech" target="_blank" class="sidebar-donate-btn" id="donation-btn" title="Chuck us a dart, legend">
          <span class="icon">ðŸš¬</span>
          <span class="text">Shout me a durry <sup class="bryan-text">do it for bryan</sup></span>
        </a>
      </aside>

      <!-- Mobile sidebar toggle -->
      <button class="sidebar-toggle" id="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle sidebar">
        <span class="toggle-icon">â—€</span>
      </button>

      <!-- Main Content -->
      <main id="app" class="main-content">
        <div class="loading">
          <div class="spinner"></div>
          <span data-i18n="loading">Loading...</span>
        </div>
      </main>
    </div>
  </div>

  <!-- Floating Genie Mascot -->
  <div class="genie-mascot" id="genie-mascot" title="Genre Genie at your service!">
    ðŸ§ž
  </div>

  <!-- Heidi Easter Egg Badge -->
  <div class="heidi-badge" onclick="toggleSwedishMode()" title="Click for a Swedish surprise!">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="8" r="4"/>
      <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
      <path d="M9 4c1-2 5-2 6 0" stroke="#FECC00"/>
    </svg>
    <span class="heidi-text">
      <span>Made with inspiration from</span>
      <span><strong>Heidi</strong> <span class="heart">â™¥</span></span>
    </span>
  </div>

  <script>
    const app = document.getElementById('app');
    const headerActions = document.getElementById('header-actions');

    let genreData = null;
    let selectedGenres = new Set();
    let swedishMode = localStorage.getItem('swedishMode') === 'true';
    let spotifyOnlyMode = false;
    let statsData = null;
    let playlistTemplate = localStorage.getItem('playlistTemplate') || '{genre} (from Likes)';

    // Hidden genres (stored in localStorage)
    let hiddenGenres = new Set(JSON.parse(localStorage.getItem('hiddenGenres') || '[]'));
    let showHiddenGenres = localStorage.getItem('showHiddenGenres') === 'true';

    // Theme preference (respects system preference by default, defaults to dark)
    let lightMode = localStorage.getItem('lightMode');
    if (lightMode === null) {
      // Default to dark mode unless system prefers light
      lightMode = window.matchMedia('(prefers-color-scheme: light)').matches;
      if (!lightMode) localStorage.setItem('lightMode', 'false');
    } else {
      lightMode = lightMode === 'true';
    }
    if (lightMode) document.body.classList.add('light-mode');

    // Add theme toggle to header immediately (visible before login)
    if (headerActions) {
      headerActions.innerHTML = \`
        <button id="theme-toggle" onclick="toggleTheme()" class="btn btn-ghost btn-sm theme-toggle-btn" title="\${lightMode ? 'Switch to dark mode' : 'Switch to light mode'}">
          \${lightMode ? 'ðŸŒ™' : 'â˜€ï¸'}
        </button>
      \`;
    }

    // Stats dashboard state
    let showStatsDashboard = localStorage.getItem('showStatsDashboard') === 'true';

    // === SWEDISH EASTER EGGS ===

    // ABBA quotes for loading messages
    const abbaQuotes = [
      'Take a chance on loading...',
      'I have a dream... of your playlists!',
      'Knowing me, knowing your music!',
      'Money, money, money... but this is free!',
      'Thank you for the music!',
      'The winner takes it all!',
      'Dancing queen, loading up the scene...',
      'Gimme gimme gimme your liked songs!',
      'Waterloo! We surrendered to your library!',
      'Super trouper, lights are gonna blind ya!',
    ];

    // Swedish fun facts for tooltip
    const swedishFacts = [
      'Sweden invented the three-point seatbelt and gave it away for free!',
      'IKEA sells about 2 billion Swedish meatballs every year!',
      'In Sweden, there\\'s a hotel made entirely of ice!',
      'Swedes love fika - coffee breaks are sacred!',
      'Sweden has more islands than any other country!',
      'The Nobel Prize was created by Swedish inventor Alfred Nobel!',
      'Minecraft was created in Sweden!',
      'Spotify was founded in Stockholm!',
      'Sweden has a phone number anyone can call to talk to a random Swede!',
      'AllemansrÃ¤tten: Swedes can camp anywhere in nature!',
    ];

    // Midsommar check (June)
    const isMidsommarSeason = new Date().getMonth() === 5; // June

    // Fika reminder (25 minutes)
    let fikaTimerStarted = false;
    let fikaTimerId = null;

    function startFikaTimer() {
      if (fikaTimerStarted || !swedishMode) return;
      fikaTimerStarted = true;
      fikaTimerId = setTimeout(() => {
        if (swedishMode) {
          showFikaReminder();
        }
      }, 25 * 60 * 1000); // 25 minutes
    }

    function showFikaReminder() {
      const reminder = document.createElement('div');
      reminder.className = 'fika-reminder';
      reminder.innerHTML = \`
        <div class="fika-content">
          <span class="fika-emoji">â˜•ðŸª</span>
          <p>Dags fÃ¶r fika!</p>
          <p style="font-size: 0.9rem; opacity: 0.8;">Time for a coffee break!</p>
          <button class="btn btn-ghost" onclick="this.closest('.fika-reminder').remove()">Tack!</button>
        </div>
      \`;
      document.body.appendChild(reminder);
    }

    function getRandomAbbaQuote() {
      return abbaQuotes[Math.floor(Math.random() * abbaQuotes.length)];
    }

    function getRandomSwedishFact() {
      return swedishFacts[Math.floor(Math.random() * swedishFacts.length)];
    }

    // Update Heidi badge tooltip with random fact
    function updateHeidiBadgeFact() {
      const badge = document.querySelector('.heidi-badge');
      if (badge && swedishMode) {
        badge.title = getRandomSwedishFact();
      }
    }

    // Swedish anthem sound (short piano melody in base64 - plays "Du gamla, Du fria" opening)
    const swedishChime = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYZNYW9jAAAAAAAAAAAAAAAAAAAAAP/7kGQAAAAAADSAAAAAAAAANIAAAAAETEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/+5JkDw/wAABpAAAACAAADSAAAAEAAAGkAAAAIAAANIAAAARVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV';

    // Deployment Monitor
    let deployStatus = null;
    let clientVersion = null;
    let deployPollInterval = null;
    const DEPLOY_CACHE_KEY = 'genreGenie_deployCache';

    // Load cached deploy status
    function loadCachedDeployStatus() {
      try {
        const cached = localStorage.getItem(DEPLOY_CACHE_KEY);
        return cached ? JSON.parse(cached) : null;
      } catch {
        return null;
      }
    }

    // Save deploy status to cache
    function cacheDeployStatus(data) {
      try {
        localStorage.setItem(DEPLOY_CACHE_KEY, JSON.stringify(data));
      } catch {}
    }

    async function checkDeployStatus() {
      try {
        const response = await fetch('/deploy-status');
        const data = await response.json();

        // Store client version on first load
        if (!clientVersion) {
          clientVersion = data.version;
        }

        deployStatus = data;
        cacheDeployStatus(data);
        updateDeployWidget(data);

        // Check for version mismatch
        if (clientVersion && data.version && clientVersion !== data.version) {
          showVersionMismatchPrompt(data.version);
        }
      } catch {
        // Use cached data if API fails
        const cached = loadCachedDeployStatus();
        if (cached) {
          deployStatus = cached;
          updateDeployWidget(cached, true);
        } else {
          // Show minimal fallback widget
          updateDeployWidget({ version: '?.?.?', deployment: null }, true);
        }
      }
    }

    function updateDeployWidget(data, isOffline = false) {
      const widget = document.getElementById('deploy-widget');
      if (!widget) return;

      const deployment = data?.deployment;
      const statusIcon = widget.querySelector('.status-icon');
      const deployText = widget.querySelector('.deploy-text');

      // ALWAYS show the widget
      widget.style.display = 'flex';
      widget.classList.remove('deploying', 'success', 'failure');

      // Get release name from changelog cache if available
      const releaseName = changelogCache?.changelog?.[0]?.changes?.[0] || '';
      const shortReleaseName = releaseName.length > 20 ? releaseName.substring(0, 20) + '...' : releaseName;

      if (deployment?.status === 'in_progress' || deployment?.status === 'queued') {
        widget.classList.add('deploying');
        statusIcon.innerHTML = '<div class="spinner-small"></div>';
        deployText.textContent = deployment.currentStep || 'Deploying...';
      } else if (deployment?.conclusion === 'success') {
        widget.classList.add('success');
        statusIcon.innerHTML = \`<img class="avatar" src="\${deployment.author?.avatar || ''}" alt="" onerror="this.style.display='none';this.parentElement.textContent='âœ“'">\`;
        const updatedAt = new Date(deployment.updatedAt);
        const timeAgo = formatTimeAgo(updatedAt);
        // Show version, release hint if available, and time
        let text = \`v\${data.version}\`;
        if (shortReleaseName) text += \` â€¢ \${shortReleaseName}\`;
        text += \` â€¢ \${timeAgo}\`;
        if (isOffline) text += ' (cached)';
        deployText.textContent = text;
      } else if (deployment?.conclusion === 'failure') {
        widget.classList.add('failure');
        statusIcon.textContent = 'âŒ';
        deployText.textContent = 'Deploy failed';
      } else {
        // Fallback: show version only
        statusIcon.textContent = 'âœ¨';
        let text = \`v\${data?.version || '?.?.?'}\`;
        if (shortReleaseName) text += \` â€¢ \${shortReleaseName}\`;
        if (isOffline) text += ' (offline)';
        deployText.textContent = text;
      }
    }

    function formatTimeAgo(date) {
      const now = new Date();
      const diff = Math.floor((now - date) / 1000);
      if (diff < 60) return 'just now';
      if (diff < 3600) return \`\${Math.floor(diff / 60)}m ago\`;
      if (diff < 86400) return \`\${Math.floor(diff / 3600)}h ago\`;
      return \`\${Math.floor(diff / 86400)}d ago\`;
    }

    function showVersionMismatchPrompt(newVersion) {
      // Don't show multiple times
      if (document.querySelector('.deploy-overlay')) return;

      const overlay = document.createElement('div');
      overlay.className = 'deploy-overlay';

      const prompt = document.createElement('div');
      prompt.className = 'deploy-refresh-prompt';
      prompt.innerHTML = \`
        <h3>ðŸš€ New Version Available!</h3>
        <p>Version \${newVersion} has been deployed. Refresh to get the latest features.</p>
        <button onclick="location.reload(true)" class="btn btn-primary">Refresh Now</button>
        <button onclick="dismissVersionPrompt()" class="btn btn-secondary" style="margin-left: 0.5rem;">Later</button>
      \`;

      document.body.appendChild(overlay);
      document.body.appendChild(prompt);
    }

    function dismissVersionPrompt() {
      document.querySelector('.deploy-overlay')?.remove();
      document.querySelector('.deploy-refresh-prompt')?.remove();
    }

    let changelogCache = null;

    async function showDeployDetails() {
      // Fetch changelog if not cached
      if (!changelogCache) {
        try {
          const res = await fetch('/api/changelog');
          changelogCache = await res.json();
        } catch {
          showNotification('Failed to load changelog', 'error');
          return;
        }
      }

      // Create overlay
      const overlay = document.createElement('div');
      overlay.className = 'changelog-overlay';
      overlay.onclick = (e) => {
        if (e.target === overlay) closeChangelog();
      };

      // Create timeline panel
      const panel = document.createElement('div');
      panel.className = 'changelog-panel';

      const header = document.createElement('div');
      header.className = 'changelog-header';
      header.innerHTML = \`
        <h3>\${swedishMode ? 'Versionshistorik' : 'Version History'}</h3>
        <button class="changelog-close" onclick="closeChangelog()">&times;</button>
      \`;

      const timeline = document.createElement('div');
      timeline.className = 'changelog-timeline';

      for (const release of changelogCache.changelog) {
        const item = document.createElement('div');
        item.className = 'changelog-item' + (release.version === deployStatus?.version ? ' current' : '');

        const dot = document.createElement('div');
        dot.className = 'changelog-dot';

        const content = document.createElement('div');
        content.className = 'changelog-content';
        content.innerHTML = \`
          <div class="changelog-version">v\${release.version}</div>
          <div class="changelog-date">\${release.date}</div>
          <ul class="changelog-changes">
            \${release.changes.map(c => \`<li>\${c}</li>\`).join('')}
          </ul>
        \`;

        item.appendChild(dot);
        item.appendChild(content);
        timeline.appendChild(item);
      }

      const footer = document.createElement('div');
      footer.className = 'changelog-footer';
      footer.innerHTML = \`<a href="\${changelogCache.repoUrl}/releases" target="_blank">\${swedishMode ? 'Visa alla utgÃ¥vor' : 'View all releases'} â†’</a>\`;

      panel.appendChild(header);
      panel.appendChild(timeline);
      panel.appendChild(footer);
      overlay.appendChild(panel);
      document.body.appendChild(overlay);

      // Animate in
      requestAnimationFrame(() => {
        overlay.classList.add('visible');
        panel.classList.add('visible');
      });
    }

    function closeChangelog() {
      const overlay = document.querySelector('.changelog-overlay');
      const panel = document.querySelector('.changelog-panel');
      if (overlay) {
        overlay.classList.remove('visible');
        panel?.classList.remove('visible');
        setTimeout(() => overlay.remove(), 300);
      }
    }
    // Make changelog functions globally accessible
    window.showDeployDetails = showDeployDetails;
    window.closeChangelog = closeChangelog;

    // Start deployment polling
    function startDeployMonitor() {
      checkDeployStatus();
      deployPollInterval = setInterval(checkDeployStatus, 10000); // Poll every 10s
    }

    // Swedish translations
    const i18n = {
      en: {
        title: 'Genre Genie',
        loading: 'Loading...',
        organiseMusic: 'Organise Your Music',
        organiseDesc: 'Automatically sort your Spotify liked songs into genre-based playlists with one click.',
        signInGithub: 'Sign in with GitHub',
        connectSpotify: 'Connect Your Spotify',
        connectDesc: 'Connect your Spotify account to analyse your liked songs and organise them by genre.',
        connectBtn: 'Connect Spotify',
        fetchingGenres: 'Fetching your liked songs and genres...',
        likedSongs: 'Liked Songs',
        genresFound: 'Genres Found',
        selected: 'Selected',
        yourGenres: 'Your Genres',
        searchGenres: 'Search genres...',
        selectAll: 'Select All',
        selectNone: 'Select None',
        createPlaylists: 'Create Playlists',
        create: 'Create',
        creating: 'Creating...',
        created: 'Created!',
        failed: 'Failed',
        results: 'Results',
        successCreated: 'Successfully created',
        of: 'of',
        playlists: 'playlists',
        openSpotify: 'Open in Spotify',
        logout: 'Logout',
        errorLoad: 'Failed to load your genres. Please try refreshing the page.',
        refresh: 'Refresh',
        tracks: 'tracks',
        errorGithubDenied: 'GitHub authorization was denied.',
        errorNotAllowed: 'Your GitHub account is not authorised to use this app.',
        errorAuthFailed: 'Authentication failed. Please try again.',
        errorInvalidState: 'Invalid state. Please try again.',
        hallOfFame: 'First Users - Hall of Fame',
        musicLoversJoined: 'music lovers have joined',
        signInSpotify: 'Sign in with Spotify',
        pioneers: 'Pioneers',
        newUsers: 'New Users',
        recentPlaylists: 'Recent Playlists',
        viewScoreboard: 'View Scoreboard',
      },
      sv: {
        title: 'Genre Genie',
        loading: 'Laddar...',
        organiseMusic: 'Organisera Din Musik',
        organiseDesc: 'Sortera automatiskt dina gillade Spotify-lÃ¥tar i genrebaserade spellistor med ett klick.',
        signInGithub: 'Logga in med GitHub',
        connectSpotify: 'Anslut Din Spotify',
        connectDesc: 'Anslut ditt Spotify-konto fÃ¶r att analysera dina gillade lÃ¥tar och organisera dem efter genre.',
        connectBtn: 'Anslut Spotify',
        fetchingGenres: 'HÃ¤mtar dina gillade lÃ¥tar och genrer...',
        likedSongs: 'Gillade LÃ¥tar',
        genresFound: 'Genrer Hittade',
        selected: 'Valda',
        yourGenres: 'Dina Genrer',
        searchGenres: 'SÃ¶k genrer...',
        selectAll: 'VÃ¤lj Alla',
        selectNone: 'VÃ¤lj Ingen',
        createPlaylists: 'Skapa Spellistor',
        create: 'Skapa',
        creating: 'Skapar...',
        created: 'Skapad!',
        failed: 'Misslyckades',
        results: 'Resultat',
        successCreated: 'Lyckades skapa',
        of: 'av',
        playlists: 'spellistor',
        openSpotify: 'Ã–ppna i Spotify',
        logout: 'Logga ut',
        errorLoad: 'Kunde inte ladda dina genrer. FÃ¶rsÃ¶k att uppdatera sidan.',
        refresh: 'Uppdatera',
        tracks: 'lÃ¥tar',
        errorGithubDenied: 'GitHub-auktorisering nekades.',
        errorNotAllowed: 'Ditt GitHub-konto Ã¤r inte behÃ¶rigt att anvÃ¤nda denna app.',
        errorAuthFailed: 'Autentisering misslyckades. FÃ¶rsÃ¶k igen.',
        errorInvalidState: 'Ogiltigt tillstÃ¥nd. FÃ¶rsÃ¶k igen.',
        hallOfFame: 'FÃ¶rsta AnvÃ¤ndarna',
        musicLoversJoined: 'musikÃ¤lskare har gÃ¥tt med',
        signInSpotify: 'Logga in med Spotify',
        pioneers: 'PionjÃ¤rer',
        newUsers: 'Nya AnvÃ¤ndare',
        recentPlaylists: 'Senaste Spellistor',
        viewScoreboard: 'Visa Resultattavla',
      }
    };

    function t(key) {
      const lang = swedishMode ? 'sv' : 'en';
      return i18n[lang][key] || i18n.en[key] || key;
    }

    // Centralised Swedish mode application - handles ALL state changes
    function applySwedishMode(enabled, options = {}) {
      const { playSound = false, showNotif = false } = options;

      // Update body classes
      document.body.classList.toggle('swedish-mode', enabled);
      if (enabled && isMidsommarSeason) {
        document.body.classList.add('midsommar');
      } else {
        document.body.classList.remove('midsommar');
      }

      // Update all translatable elements
      document.querySelectorAll('[data-i18n]').forEach(el => {
        el.textContent = t(el.dataset.i18n);
      });

      // Update donation button (durry -> snus)
      const donationBtn = document.getElementById('donation-btn');
      if (donationBtn) {
        const icon = donationBtn.querySelector('.icon');
        const text = donationBtn.querySelector('.text');
        if (enabled) {
          if (icon) icon.textContent = 'ðŸ«™';
          if (text) text.textContent = 'Bjud mig pÃ¥ snus';
          donationBtn.title = 'Tack fÃ¶r stÃ¶det, kompis!';
        } else {
          if (icon) icon.textContent = 'ðŸš¬';
          if (text) text.textContent = 'Shout me a durry';
          donationBtn.title = 'Chuck us a dart, legend';
        }
      }

      // Update Heidi badge
      const heidiBadge = document.querySelector('.heidi-badge');
      if (heidiBadge) {
        const heidiText = heidiBadge.querySelector('.heidi-text span');
        if (heidiText) {
          heidiText.textContent = enabled ? 'FÃ¶r Heidi' : 'For Heidi';
        }
      }

      // Update placeholder text in search inputs
      const searchInput = document.querySelector('.search-input');
      if (searchInput) {
        searchInput.placeholder = enabled ? 'SÃ¶k genrer... (/ fÃ¶r att fokusera)' : 'Search genres... (/ to focus)';
      }

      // Update Hall of Fame title if visible
      const hofTitle = document.querySelector('.hall-of-fame h3');
      if (hofTitle) {
        hofTitle.textContent = enabled ? 'ðŸ† HedersvÃ¤gg' : 'ðŸ† Hall of Fame';
      }

      // Update loading messages if loading is in progress
      const loadingMessage = document.querySelector('.progress-message, .loading span');
      if (loadingMessage && loadingMessage.textContent) {
        // Loading messages will be updated by the loading functions
      }

      // Play sound and show notification only on toggle (not on page load)
      if (playSound && enabled) {
        try {
          const audio = new Audio(swedishChime);
          audio.volume = 0.3;
          audio.play().catch(() => {});
        } catch {}
      }

      if (showNotif) {
        if (enabled) {
          showNotification('ðŸ‡¸ðŸ‡ª VÃ¤lkommen till svenskt lÃ¤ge! Tack Heidi! ðŸ‘‘', 'success');
        } else {
          showNotification('Back to normal mode!', 'success');
        }
      }

      // Start/stop fika timer
      if (enabled) {
        startFikaTimer();
        updateHeidiBadgeFact();
      }

      // Re-render current view to update all text
      if (genreData) {
        renderGenres();
      }

      // Re-render sidebar content with updated language
      if (typeof renderPioneers === 'function') renderPioneers();
      if (typeof renderNewUsers === 'function') renderNewUsers();
      if (typeof renderRecentPlaylists === 'function') renderRecentPlaylists();
    }

    function toggleSwedishMode() {
      swedishMode = !swedishMode;
      localStorage.setItem('swedishMode', swedishMode);
      applySwedishMode(swedishMode, { playSound: true, showNotif: true });
    }
    // Make toggleSwedishMode globally accessible
    window.toggleSwedishMode = toggleSwedishMode;

    // Apply Swedish mode on load if previously enabled
    if (swedishMode) {
      // Defer to ensure DOM is ready
      setTimeout(() => applySwedishMode(true, { playSound: false, showNotif: false }), 0);
    }

    async function init() {
      // Check for errors in URL
      const params = new URLSearchParams(window.location.search);
      const error = params.get('error');

      // Load stats for user counter
      try {
        statsData = await fetch('/stats').then(r => r.json());
      } catch {}

      // Check session
      const session = await fetch('/session').then(r => r.json());
      spotifyOnlyMode = session.spotifyOnly || false;

      if (!session.authenticated) {
        renderWelcome(error);
        return;
      }

      renderHeaderUser(session);

      // In Spotify-only mode, we're already connected if authenticated
      if (!spotifyOnlyMode && !session.spotifyConnected) {
        renderConnectSpotify();
        return;
      }

      renderLoading(t('fetchingGenres'));
      await loadGenres();
    }

    function renderWelcome(error) {
      const errorMessages = {
        'github_denied': t('errorGithubDenied'),
        'not_allowed': t('errorNotAllowed'),
        'auth_failed': t('errorAuthFailed'),
        'invalid_state': t('errorInvalidState'),
        'spotify_denied': 'Spotify authorisation was denied.',
        'spotify_auth_failed': 'Spotify authentication failed. Please try again.',
      };

      // User counter HTML - now with Swedish translation
      const userCounterHtml = statsData?.userCount ? \`
        <div class="user-counter">
          <span>\${swedishMode ? 'ðŸ‡¸ðŸ‡ª' : 'ðŸŽµ'}</span>
          <span><span class="count">\${statsData.userCount}</span> \${t('musicLoversJoined')}</span>
        </div>
      \` : '';

      // Hall of fame removed - now using sidebar Pioneers section

      // Different login button based on mode
      const loginButton = spotifyOnlyMode ? \`
        <a href="/auth/spotify" class="btn btn-primary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.586 14.424a.622.622 0 01-.857.207c-2.348-1.435-5.304-1.76-8.785-.964a.622.622 0 01-.277-1.215c3.809-.87 7.076-.496 9.712 1.115.293.18.386.563.207.857zm1.223-2.722a.78.78 0 01-1.072.257c-2.687-1.652-6.785-2.131-9.965-1.166a.78.78 0 01-.973-.519.781.781 0 01.52-.972c3.632-1.102 8.147-.568 11.233 1.329a.78.78 0 01.257 1.071zm.105-2.835c-3.223-1.914-8.54-2.09-11.618-1.156a.935.935 0 11-.543-1.79c3.533-1.072 9.404-.865 13.115 1.338a.935.935 0 11-.954 1.608z"/>
          </svg>
          <span>\${t('signInSpotify')}</span>
        </a>
      \` : \`
        <a href="/auth/github" class="btn btn-primary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.374 0 0 5.373 0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23A11.509 11.509 0 0112 5.803c1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/>
          </svg>
          <span data-i18n="signInGithub">\${t('signInGithub')}</span>
        </a>
      \`;

      app.innerHTML = \`
        <div class="welcome">
          \${error ? \`<div class="error">\${errorMessages[error] || error}</div>\` : ''}
          \${userCounterHtml}
          <h2 data-i18n="organiseMusic">\${t('organiseMusic')}</h2>
          <p data-i18n="organiseDesc">\${t('organiseDesc')}</p>
          \${loginButton}
          <div class="footer-badges">
            <a href="https://github.com/TomsTech/spotify-genre-sorter" target="_blank">
              <img src="https://img.shields.io/github/stars/TomsTech/spotify-genre-sorter?style=for-the-badge&logo=github&logoColor=white&label=Star&color=1DB954&labelColor=191414" alt="Star on GitHub" loading="lazy" onerror="this.style.display='none'">
            </a>
            <a href="https://status.houstons.tech" target="_blank">
              <img src="https://uptime.betterstack.com/status-badges/v3/monitor/3843047.svg" alt="Uptime" loading="lazy" onerror="this.style.display='none'">
            </a>
          </div>
        </div>
      \`;
    }

    function renderHeaderUser(session) {
      const avatar = session.avatar || session.spotifyAvatar || session.githubAvatar;
      const user = session.user || session.spotifyUser || session.githubUser;
      const lightMode = document.body.classList.contains('light-mode');
      // Keep theme toggle in header, add user info next to it
      headerActions.innerHTML = \`
        <button id="theme-toggle" onclick="toggleTheme()" class="btn btn-ghost btn-sm theme-toggle-btn" title="\${lightMode ? 'Switch to dark mode' : 'Switch to light mode'}">
          \${lightMode ? 'ðŸŒ™' : 'â˜€ï¸'}
        </button>
        <div class="user-info">
          \${avatar ? \`<img src="\${avatar}" alt="" class="avatar" onerror="this.style.display='none'">\` : ''}
          <span>\${user || 'User'}</span>
          <a href="/auth/logout" class="btn btn-ghost" data-i18n="logout">\${t('logout')}</a>
        </div>
      \`;
    }

    function renderConnectSpotify() {
      app.innerHTML = \`
        <div class="card">
          <h2 class="card-title" data-i18n="connectSpotify">\${t('connectSpotify')}</h2>
          <p style="color: var(--text-muted); margin-bottom: 1.5rem;" data-i18n="connectDesc">
            \${t('connectDesc')}
          </p>
          <a href="/auth/spotify" class="btn btn-primary">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm4.586 14.424a.622.622 0 01-.857.207c-2.348-1.435-5.304-1.76-8.785-.964a.622.622 0 01-.277-1.215c3.809-.87 7.076-.496 9.712 1.115.293.18.386.563.207.857zm1.223-2.722a.78.78 0 01-1.072.257c-2.687-1.652-6.785-2.131-9.965-1.166a.78.78 0 01-.973-.519.781.781 0 01.52-.972c3.632-1.102 8.147-.568 11.233 1.329a.78.78 0 01.257 1.071zm.105-2.835c-3.223-1.914-8.54-2.09-11.618-1.156a.935.935 0 11-.543-1.79c3.533-1.072 9.404-.865 13.115 1.338a.935.935 0 11-.954 1.608z"/>
            </svg>
            <span data-i18n="connectBtn">\${t('connectBtn')}</span>
          </a>
        </div>
      \`;
    }

    function renderLoading(message, subMessage = '') {
      // Use ABBA quotes in Swedish mode
      const displayMessage = swedishMode ? getRandomAbbaQuote() : message;
      app.innerHTML = \`
        <div class="loading">
          <div class="spinner"></div>
          <span>\${displayMessage}</span>
          \${subMessage ? \`<span class="loading-sub">\${subMessage}</span>\` : ''}
        </div>
      \`;
    }

    // Genre emoji mapping for common genres
    const genreEmojis = {
      'rock': 'ðŸŽ¸', 'pop': 'ðŸŽ¤', 'hip hop': 'ðŸŽ§', 'rap': 'ðŸŽ¤', 'jazz': 'ðŸŽ·',
      'classical': 'ðŸŽ»', 'electronic': 'ðŸŽ¹', 'dance': 'ðŸ’ƒ', 'r&b': 'ðŸŽµ', 'soul': 'ðŸ’œ',
      'country': 'ðŸ¤ ', 'folk': 'ðŸª•', 'blues': 'ðŸŽº', 'metal': 'ðŸ¤˜', 'punk': 'âš¡',
      'indie': 'ðŸŽª', 'alternative': 'ðŸ”®', 'reggae': 'ðŸŒ´', 'latin': 'ðŸ’ƒ', 'disco': 'ðŸª©',
      'house': 'ðŸ ', 'techno': 'ðŸ”Š', 'ambient': 'ðŸŒ™', 'chill': 'ðŸ˜Œ', 'lofi': 'ðŸ“»',
      'k-pop': 'ðŸ‡°ðŸ‡·', 'j-pop': 'ðŸ‡¯ðŸ‡µ', 'swedish': 'ðŸ‡¸ðŸ‡ª', 'australian': 'ðŸ¦˜',
      'punk rock': 'ðŸŽ¸', 'hard rock': 'ðŸ”¥', 'soft rock': 'ðŸŒ¸', 'classic rock': 'ðŸŽ¸',
      'death metal': 'ðŸ’€', 'black metal': 'â¬›', 'heavy metal': 'ðŸ¤˜',
      'trap': 'ðŸ”¥', 'drill': 'ðŸ”«', 'grime': 'ðŸ‡¬ðŸ‡§', 'uk garage': 'ðŸ‡¬ðŸ‡§',
      'edm': 'ðŸŽ†', 'dubstep': 'ðŸ“¢', 'drum and bass': 'ðŸ¥', 'trance': 'ðŸŒ€',
      'gospel': 'â›ª', 'christian': 'âœï¸', 'worship': 'ðŸ™',
      'soundtrack': 'ðŸŽ¬', 'video game': 'ðŸŽ®', 'anime': 'ðŸŽŒ',
      'christmas': 'ðŸŽ„', 'holiday': 'ðŸŽ', 'summer': 'â˜€ï¸', 'winter': 'â„ï¸',
      'workout': 'ðŸ’ª', 'party': 'ðŸŽ‰', 'sleep': 'ðŸ˜´', 'focus': 'ðŸ§ ', 'study': 'ðŸ“š',
      'romantic': 'â¤ï¸', 'sad': 'ðŸ˜¢', 'happy': 'ðŸ˜Š', 'angry': 'ðŸ˜ ',
    };

    function getGenreEmoji(genreName) {
      const lower = genreName.toLowerCase();
      // Direct match
      if (genreEmojis[lower]) return genreEmojis[lower];
      // Partial match
      for (const [key, emoji] of Object.entries(genreEmojis)) {
        if (lower.includes(key) || key.includes(lower)) return emoji;
      }
      return 'ðŸŽµ'; // Default music note
    }

    // Escape text for safe HTML/JSON output
    function escapeForHtml(text) {
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Album art carousel state
    let albumArtUrls = [];
    let albumCarouselIndex = 0;
    let albumCarouselInterval = null;

    // Animated counter helper - adds pulse effect when value changes
    function animateCounter(element, newValue) {
      if (!element) return;
      const oldValue = element.textContent;
      if (oldValue !== newValue) {
        element.classList.add('counting');
        element.textContent = newValue;
        setTimeout(() => element.classList.remove('counting'), 300);
      }
    }

    // Rotate album carousel to show different covers with vinyl flip animation
    function rotateAlbumCarousel() {
      const carousel = document.getElementById('album-carousel');
      if (!carousel) return;

      // If we have real album art, rotate through it
      if (albumArtUrls.length >= 3) {
        // Add flip animation to center item
        const centerItem = carousel.querySelector('.album-art-item.center');
        if (centerItem) {
          centerItem.style.animation = 'vinylFlip 0.8s ease-in-out';
          setTimeout(() => {
            if (centerItem.style) centerItem.style.animation = '';
          }, 800);
        }

        // Update index and carousel after flip starts
        setTimeout(() => {
          albumCarouselIndex = (albumCarouselIndex + 1) % albumArtUrls.length;
          updateAlbumCarousel();
        }, 400);
      } else {
        // Placeholder animation - rotate emojis with flip
        const items = carousel.querySelectorAll('.album-art-item');
        items.forEach(item => {
          item.style.animation = 'vinylFlip 0.8s ease-in-out';
        });

        setTimeout(() => {
          const emojis = ['ðŸŽµ', 'ðŸŽ¶', 'ðŸŽ¸', 'ðŸŽ¹', 'ðŸ¥', 'ðŸŽº', 'ðŸŽ·', 'ðŸŽ»', 'ðŸŽ¤'];
          items.forEach(item => {
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            item.textContent = randomEmoji;
            if (item.style) item.style.animation = '';
          });
        }, 400);
      }
    }

    // Update album carousel display
    function updateAlbumCarousel() {
      const carousel = document.getElementById('album-carousel');
      if (!carousel || albumArtUrls.length < 3) return;

      const len = albumArtUrls.length;
      const leftIdx = (albumCarouselIndex - 1 + len) % len;
      const centerIdx = albumCarouselIndex;
      const rightIdx = (albumCarouselIndex + 1) % len;

      carousel.innerHTML = [
        '<div class="album-art-item left visible">',
        '<img src="' + albumArtUrls[leftIdx] + '" alt="" loading="lazy">',
        '</div>',
        '<div class="album-art-item center visible">',
        '<img src="' + albumArtUrls[centerIdx] + '" alt="" loading="lazy">',
        '</div>',
        '<div class="album-art-item right visible">',
        '<img src="' + albumArtUrls[rightIdx] + '" alt="" loading="lazy">',
        '</div>'
      ].join('');
    }

    // Update bar chart with top genres
    function updateBarChart(genres) {
      const container = document.getElementById('bar-chart-items');
      if (!container) return;

      const sortedGenres = [...genres].sort((a, b) => b.count - a.count).slice(0, 8);
      const maxCount = sortedGenres[0]?.count || 1;

      container.innerHTML = sortedGenres.map(g => {
        const percentage = (g.count / maxCount) * 100;
        const safeName = escapeForHtml(g.name);
        return [
          '<div class="bar-chart-item">',
          '<div class="bar-chart-label">' + safeName + '</div>',
          '<div class="bar-chart-bar-container">',
          '<div class="bar-chart-bar" style="width: ' + percentage + '%"></div>',
          '</div>',
          '<div class="bar-chart-count">' + g.count + '</div>',
          '</div>'
        ].join('');
      }).join('');
    }

    // Clean up carousel interval when loading completes
    function stopAlbumCarousel() {
      if (albumCarouselInterval) {
        clearInterval(albumCarouselInterval);
        albumCarouselInterval = null;
      }
      albumArtUrls = [];
      albumCarouselIndex = 0;
    }

    // Fireworks celebration effect
    function triggerFireworks() {
      const colors = ['#1DB954', '#1ed760', '#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'];
      const container = document.createElement('div');
      container.className = 'fireworks-container';
      document.body.appendChild(container);

      // Create celebration text
      const celebText = document.createElement('div');
      celebText.className = 'celebration-text';
      celebText.textContent = swedishMode ? 'ðŸŽ‰ Klart!' : 'ðŸŽ‰ Done!';
      document.body.appendChild(celebText);

      // Launch multiple fireworks
      for (let i = 0; i < 8; i++) {
        setTimeout(() => launchFirework(container, colors), i * 150);
      }

      // Play a subtle celebration sound (optional, won't play if audio not allowed)
      try {
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
        oscillator.frequency.setValueAtTime(659.25, audioCtx.currentTime + 0.1); // E5
        oscillator.frequency.setValueAtTime(783.99, audioCtx.currentTime + 0.2); // G5
        gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
        oscillator.start(audioCtx.currentTime);
        oscillator.stop(audioCtx.currentTime + 0.5);
      } catch (e) {
        // Audio not available, that's fine
      }

      // Clean up after animation
      setTimeout(() => {
        celebText.classList.add('fade-out');
        setTimeout(() => {
          container.remove();
          celebText.remove();
        }, 500);
      }, 2000);
    }

    function launchFirework(container, colors) {
      const x = Math.random() * window.innerWidth;
      const y = Math.random() * (window.innerHeight * 0.6) + (window.innerHeight * 0.1);
      const color = colors[Math.floor(Math.random() * colors.length)];
      const particleCount = 20 + Math.floor(Math.random() * 15);

      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'firework-particle';
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.backgroundColor = color;
        particle.style.boxShadow = '0 0 6px ' + color;

        const angle = (Math.PI * 2 * i) / particleCount + (Math.random() - 0.5) * 0.5;
        const velocity = 50 + Math.random() * 100;
        const dx = Math.cos(angle) * velocity;
        const dy = Math.sin(angle) * velocity;

        particle.style.animation = 'none';
        particle.animate([
          { transform: 'translate(0, 0) scale(1)', opacity: 1 },
          { transform: 'translate(' + dx + 'px, ' + (dy + 30) + 'px) scale(0)', opacity: 0 }
        ], {
          duration: 1000 + Math.random() * 500,
          easing: 'cubic-bezier(0, 0.5, 0.5, 1)'
        });

        container.appendChild(particle);

        setTimeout(() => particle.remove(), 1500);
      }
    }

    function renderProgressLoading(message, progress, loaded, total, partialGenres = null, partialStats = null) {
      // Check if progress bar already exists
      let progressContainer = document.getElementById('progressive-loading');

      // Calculate partial stats
      const genreCount = partialGenres?.length || 0;
      const artistCount = partialStats?.artistCount || 0;

      if (!progressContainer) {
        // First call - create the full interactive UI
        app.innerHTML = \`
          <div id="progressive-loading" class="progressive-loading-full">
            <div class="album-art-carousel" id="album-carousel"><div class="album-art-item left placeholder visible">ðŸŽµ</div><div class="album-art-item center placeholder visible">ðŸŽ¶</div><div class="album-art-item right placeholder visible">ðŸŽµ</div></div><div class="loading-header">
              <h2>\${swedishMode ? 'ðŸŽµ Laddar ditt bibliotek...' : 'ðŸŽµ Loading your library...'}</h2>
              <p class="loading-subtitle">\${swedishMode ? 'Du kan redan se dina genrer medan det laddar!' : 'You can already see your genres while loading!'}</p>
            </div>

            <div class="loading-stats-row">
              <div class="loading-stat">
                <div class="loading-stat-value" id="stat-tracks">\${loaded.toLocaleString()}</div>
                <div class="loading-stat-label">\${swedishMode ? 'lÃ¥tar' : 'tracks'}</div>
              </div>
              <div class="loading-stat">
                <div class="loading-stat-value" id="stat-genres">\${genreCount}</div>
                <div class="loading-stat-label">\${swedishMode ? 'genrer' : 'genres'}</div>
              </div>
              <div class="loading-stat">
                <div class="loading-stat-value" id="stat-artists">\${artistCount}</div>
                <div class="loading-stat-label">\${swedishMode ? 'artister' : 'artists'}</div>
              </div>
              <div class="loading-stat">
                <div class="loading-stat-value" id="stat-progress">\${progress}%</div>
                <div class="loading-stat-label">\${swedishMode ? 'klart' : 'complete'}</div>
              </div>
            </div>

            <div class="progress-container-full">
              <div class="progress-bar-full">
                <div class="progress-fill-full" id="progress-fill" style="width: \${progress}%"></div>
              </div>
              <div class="progress-detail" id="progress-detail">
                \${loaded.toLocaleString()} / \${total.toLocaleString()} \${swedishMode ? 'lÃ¥tar' : 'tracks'}
              </div>
            </div>

            <div class="live-genres-section">
              <h3>\${swedishMode ? 'ðŸŽ¸ Genrer hittade hittills' : 'ðŸŽ¸ Genres found so far'}</h3>
              <div class="live-genres-grid" id="live-genres-grid"></div><div class="live-bar-chart" id="live-bar-chart"><h4>\${swedishMode ? "ðŸ“Š Topp genrer" : "ðŸ“Š Top Genres"}</h4><div id="bar-chart-items"></div></div></div></div>
        \`;
        progressContainer = document.getElementById('progressive-loading');

        // Start album carousel rotation
        if (!albumCarouselInterval) {
          albumCarouselInterval = setInterval(rotateAlbumCarousel, 1500);
        }
      } else {
        // Update existing stats with animation
        animateCounter(document.getElementById('stat-tracks'), loaded.toLocaleString());
        animateCounter(document.getElementById('stat-genres'), String(genreCount));
        animateCounter(document.getElementById('stat-artists'), String(artistCount));
        animateCounter(document.getElementById('stat-progress'), progress + '%');

        const fill = document.getElementById('progress-fill');
        const detail = document.getElementById('progress-detail');
        if (fill) fill.style.width = \`\${progress}%\`;
        if (detail) detail.textContent = \`\${loaded.toLocaleString()} / \${total.toLocaleString()} \${swedishMode ? 'lÃ¥tar' : 'tracks'}\`;
      }

      // Update live genres grid with emojis
      if (partialGenres && partialGenres.length > 0) {
        const grid = document.getElementById('live-genres-grid');
        if (grid) {
          // Show top genres with emojis, sorted by count
          const sortedGenres = [...partialGenres].sort((a, b) => b.count - a.count).slice(0, 20);
          grid.innerHTML = sortedGenres.map(g => {
            const emoji = getGenreEmoji(g.name);
            const safeName = escapeForHtml(g.name);
            return \`
              <div class="live-genre-card">
                <span class="live-genre-emoji">\${emoji}</span>
                <span class="live-genre-name">\${safeName}</span>
                <span class="live-genre-count">\${g.count}</span>
              </div>
            \`;
          }).join('');
        }

        // Update bar chart
        updateBarChart(partialGenres);
      }
    }

    // Merge genre data from multiple chunks
    function mergeGenreChunks(existing, newChunk) {
      const merged = new Map();

      // Add existing genres
      if (existing?.genres) {
        for (const g of existing.genres) {
          merged.set(g.name, { count: g.count, trackIds: [...g.trackIds] });
        }
      }

      // Merge new chunk genres
      for (const g of newChunk.genres) {
        if (merged.has(g.name)) {
          const existing = merged.get(g.name);
          existing.count += g.count;
          existing.trackIds.push(...g.trackIds);
        } else {
          merged.set(g.name, { count: g.count, trackIds: [...g.trackIds] });
        }
      }

      // Convert to sorted array
      const genres = [...merged.entries()]
        .map(([name, data]) => ({ name, count: data.count, trackIds: data.trackIds }))
        .sort((a, b) => b.count - a.count);

      return {
        genres,
        totalTracks: (existing?.totalTracks || 0) + newChunk.trackCount,
        totalGenres: genres.length,
        totalArtists: (existing?.totalArtists || 0) + newChunk.artistCount,
        cachedAt: Date.now(),
      };
    }

    // Progressive loading for large libraries
    async function loadGenresProgressively() {
      let offset = 0;
      let accumulated = null;
      let totalInLibrary = 0;

      while (true) {
        const response = await fetch(\`/api/genres/chunk?offset=\${offset}&limit=500\`);
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.details || data.error || 'Failed to load chunk');
        }

        totalInLibrary = data.pagination.totalInLibrary;

        // Merge this chunk first so we can show preview
        accumulated = mergeGenreChunks(accumulated, data.chunk);

        // Update progress UI with accumulated genres preview
        const loadedTracks = offset + data.chunk.trackCount;
        renderProgressLoading(
          swedishMode ? 'Laddar ditt bibliotek...' : 'Loading your library...',
          data.progress,
          loadedTracks,
          totalInLibrary,
          accumulated?.genres || [],
          { artistCount: accumulated?.totalArtists || 0 }
        );

        // Check if done
        if (!data.pagination.hasMore) {
          break;
        }

        offset = data.pagination.nextOffset;
      }

      // Remove truncated flag since we loaded everything
      accumulated.truncated = false;
      accumulated.totalInLibrary = totalInLibrary;

      return accumulated;
    }

    // Load full library using progressive loading
    async function loadFullLibrary() {
      try {
        const fullData = await loadGenresProgressively();
        stopAlbumCarousel(); // Clean up carousel when loading completes
        genreData = fullData;
        triggerFireworks(); // Celebrate completion!
        renderGenres();
        showNotification(
          swedishMode ? 'âœ¨ Hela biblioteket laddat!' : 'âœ¨ Full library loaded!',
          'success'
        );
      } catch (error) {
        console.error('Progressive load error:', error);
        stopAlbumCarousel(); // Clean up carousel on error too
        showNotification(
          swedishMode ? 'Kunde inte ladda alla lÃ¥tar' : 'Failed to load all tracks',
          'error'
        );
        // Re-render with partial data
        if (genreData) {
          renderGenres();
        }
      }
    }

    async function loadGenres() {
      try {
        renderLoading(
          swedishMode ? 'HÃ¤mtar dina lÃ¥tar...' : 'Fetching your liked songs...',
          swedishMode ? 'Detta kan ta en stund fÃ¶r stora bibliotek' : 'This may take a moment for large libraries'
        );

        // First, try the standard endpoint (fast for small libraries)
        const response = await fetch('/api/genres');
        const data = await response.json();

        if (!response.ok) {
          // Show detailed error from API
          const errorDetail = data.details || data.error || 'Unknown error';
          const step = data.step || 'unknown';
          const stepLabels = {
            'fetching_tracks': 'while fetching your liked tracks',
            'fetching_artists': 'while fetching artist data',
            'unknown': ''
          };

          app.innerHTML = \`
            <div class="error">
              <strong>Error \${stepLabels[step] || ''}</strong>
              <p>\${errorDetail}</p>
              \${data.tracksFound ? \`<p class="error-detail">Tracks found: \${data.tracksFound}</p>\` : ''}
              \${data.artistsToFetch ? \`<p class="error-detail">Artists to fetch: \${data.artistsToFetch}</p>\` : ''}
            </div>
            <button onclick="loadGenres()" class="btn btn-secondary">Try Again</button>
            <button onclick="location.href='/auth/logout'" class="btn btn-secondary">Reconnect Spotify</button>
          \`;
          return;
        }

        if (data.totalTracks === 0) {
          app.innerHTML = \`
            <div class="card">
              <h2>No Liked Songs Found</h2>
              <p>Your Spotify library doesn't have any liked songs yet. Like some songs on Spotify and come back!</p>
            </div>
          \`;
          return;
        }

        genreData = data;
        triggerFireworks(); // Celebrate completion!
        renderGenres();
      } catch (error) {
        console.error('Load genres error:', error);
        app.innerHTML = \`
          <div class="error">
            <strong>Connection Error</strong>
            <p>Could not connect to the server. Please check your internet connection.</p>
            <p class="error-detail">\${error.message || 'Unknown error'}</p>
          </div>
          <button onclick="loadGenres()" class="btn btn-secondary">Try Again</button>
        \`;
      }
    }

    async function refreshGenres() {
      try {
        renderLoading(
          swedishMode ? 'Uppdaterar frÃ¥n Spotify...' : 'Refreshing from Spotify...',
          swedishMode ? 'HÃ¤mtar senaste data' : 'Fetching latest data'
        );

        const response = await fetch('/api/genres?refresh=true');
        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.details || data.error || 'Failed to refresh');
        }

        genreData = data;
        renderGenres();
        showNotification(swedishMode ? 'âœ¨ Data uppdaterad!' : 'âœ¨ Data refreshed!', 'success');
      } catch (error) {
        console.error('Refresh error:', error);
        showNotification(swedishMode ? 'Kunde inte uppdatera' : 'Failed to refresh', 'error');
        // Re-render with existing data if we have it
        if (genreData) {
          renderGenres();
        }
      }
    }

    function formatCacheTime(cachedAt) {
      if (!cachedAt) return '';
      const now = Date.now();
      const diff = Math.floor((now - cachedAt) / 1000);
      if (diff < 60) return swedishMode ? 'Just nu' : 'Just now';
      if (diff < 3600) {
        const mins = Math.floor(diff / 60);
        return swedishMode ? \`\${mins} min sedan\` : \`\${mins}m ago\`;
      }
      const hours = Math.floor(diff / 3600);
      return swedishMode ? \`\${hours} tim sedan\` : \`\${hours}h ago\`;
    }

    // === Hidden Genres Functions ===
    function toggleHideGenre(genre) {
      if (hiddenGenres.has(genre)) {
        hiddenGenres.delete(genre);
      } else {
        hiddenGenres.add(genre);
      }
      saveHiddenGenres();
      filterAndRenderGenres(document.querySelector('.search-input')?.value || '');
      updateHiddenCount();
    }

    function saveHiddenGenres() {
      localStorage.setItem('hiddenGenres', JSON.stringify([...hiddenGenres]));
    }

    function toggleShowHidden() {
      showHiddenGenres = !showHiddenGenres;
      localStorage.setItem('showHiddenGenres', showHiddenGenres.toString());
      filterAndRenderGenres(document.querySelector('.search-input')?.value || '');
      updateHiddenCount();
    }

    function hideSmallGenres(minTracks) {
      if (!genreData?.genres) return;
      genreData.genres.forEach(g => {
        if (g.count < minTracks) {
          hiddenGenres.add(g.name);
        }
      });
      saveHiddenGenres();
      filterAndRenderGenres(document.querySelector('.search-input')?.value || '');
      updateHiddenCount();
    }

    function unhideAllGenres() {
      hiddenGenres.clear();
      saveHiddenGenres();
      filterAndRenderGenres(document.querySelector('.search-input')?.value || '');
      updateHiddenCount();
    }

    function updateHiddenCount() {
      const countEl = document.getElementById('hidden-count');
      if (countEl) {
        countEl.textContent = hiddenGenres.size.toString();
      }
      const toolbar = document.getElementById('hidden-toolbar');
      if (toolbar) {
        toolbar.style.display = hiddenGenres.size > 0 ? 'flex' : 'none';
      }
    }

    // === Theme Toggle Functions ===
    function toggleTheme() {
      lightMode = !lightMode;
      localStorage.setItem('lightMode', lightMode.toString());
      document.body.classList.toggle('light-mode', lightMode);
      updateThemeButton();
    }
    window.toggleTheme = toggleTheme;

    function updateThemeButton() {
      const btn = document.getElementById('theme-toggle');
      if (btn) {
        btn.textContent = lightMode ? 'ðŸŒ™' : 'â˜€ï¸';
        btn.title = lightMode
          ? (swedishMode ? 'Byt till mÃ¶rkt lÃ¤ge' : 'Switch to dark mode')
          : (swedishMode ? 'Byt till ljust lÃ¤ge' : 'Switch to light mode');
      }
    }

    // === Export Functions ===
    // Sanitize text for safe export - NO REGEX with escape sequences (they break in template literals)
    function sanitizeForExport(text) {
      if (!text || typeof text !== 'string') return '';

      // Normalize unicode to NFC form
      let result = text.normalize('NFC');

      // Remove control characters manually (safer than regex escapes)
      let cleaned = '';
      for (let i = 0; i < result.length; i++) {
        const code = result.charCodeAt(i);
        // Skip control characters: 0x00-0x1F (C0) and 0x7F-0x9F (DEL + C1)
        if ((code >= 0x20 && code <= 0x7E) || code >= 0xA0) {
          cleaned += result[i];
        }
      }

      return cleaned.trim();
    }

    function exportGenresJSON() {
      if (!genreData) return;
      const exportData = {
        exportedAt: new Date().toISOString(),
        totalTracks: genreData.totalTracks,
        totalGenres: genreData.totalGenres,
        totalArtists: genreData.totalArtists,
        genres: genreData.genres.map(g => ({
          name: sanitizeForExport(g.name),
          trackCount: g.count,
          trackIds: g.trackIds
        }))
      };
      // Use UTF-8 BOM for better compatibility with Excel
      const jsonString = JSON.stringify(exportData, null, 2);
      const blob = new Blob(['\\uFEFF' + jsonString], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'spotify-genres-' + new Date().toISOString().slice(0, 10) + '.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportGenresCSV() {
      if (!genreData) return;
      const rows = [['Genre', 'Track Count', 'Track IDs']];
      genreData.genres.forEach(g => {
        // Sanitize genre name and escape for CSV
        const safeName = sanitizeForExport(g.name);
        rows.push([safeName, g.count.toString(), g.trackIds.join(';')]);
      });
      // Escape quotes and wrap in quotes, handle newlines
      const csv = rows.map(row => row.map(cell => {
        const escaped = String(cell).replace(/"/g, '""').replace(/\\r?\\n/g, ' ');
        return '"' + escaped + '"';
      }).join(',')).join('\\r\\n'); // Use CRLF for better compatibility
      // Use UTF-8 BOM for better compatibility with Excel
      const blob = new Blob(['\\uFEFF' + csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'spotify-genres-' + new Date().toISOString().slice(0, 10) + '.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    // === Stats Dashboard Functions ===
    function calculateDiversityScore(genres) {
      if (!genres || genres.length === 0) return 0;
      const total = genres.reduce((sum, g) => sum + g.count, 0);
      if (total === 0) return 0;
      // Shannon diversity index (normalized to 0-100)
      let entropy = 0;
      genres.forEach(g => {
        const p = g.count / total;
        if (p > 0) entropy -= p * Math.log(p);
      });
      const maxEntropy = Math.log(genres.length);
      return maxEntropy > 0 ? Math.round((entropy / maxEntropy) * 100) : 0;
    }

    function getDiversityLabel(score) {
      if (score >= 80) return swedishMode ? 'Mycket varierad!' : 'Very diverse!';
      if (score >= 60) return swedishMode ? 'Varierad' : 'Diverse';
      if (score >= 40) return swedishMode ? 'MÃ¥ttlig' : 'Moderate';
      if (score >= 20) return swedishMode ? 'Fokuserad' : 'Focused';
      return swedishMode ? 'Mycket fokuserad' : 'Very focused';
    }

    function calculateAvgGenresPerTrack() {
      if (!genreData?.genres || genreData.totalTracks === 0) return 0;
      const totalGenreAssignments = genreData.genres.reduce((sum, g) => sum + g.count, 0);
      return (totalGenreAssignments / genreData.totalTracks).toFixed(1);
    }

    function toggleStatsDashboard() {
      showStatsDashboard = !showStatsDashboard;
      localStorage.setItem('showStatsDashboard', showStatsDashboard.toString());
      const dashboard = document.getElementById('stats-dashboard');
      const toggleBtn = document.getElementById('stats-toggle');
      if (dashboard) {
        dashboard.style.display = showStatsDashboard ? 'block' : 'none';
      }
      if (toggleBtn) {
        toggleBtn.textContent = showStatsDashboard
          ? (swedishMode ? 'DÃ¶lj statistik' : 'Hide Stats')
          : (swedishMode ? 'Visa statistik' : 'Show Stats');
      }
    }

    function renderStatsDashboard() {
      if (!genreData?.genres) return '';
      const top10 = genreData.genres.slice(0, 10);
      const maxCount = top10[0]?.count || 1;
      const diversityScore = calculateDiversityScore(genreData.genres);
      const avgGenres = calculateAvgGenresPerTrack();

      return \`
        <div class="stats-dashboard" id="stats-dashboard" style="display: \${showStatsDashboard ? 'block' : 'none'}">
          <h3>\${swedishMode ? 'ðŸ“Š Musiksmak Analys' : 'ðŸ“Š Music Taste Analysis'}</h3>

          <div class="stats-section">
            <h4>\${swedishMode ? 'Topp 10 Genrer' : 'Top 10 Genres'}</h4>
            <div class="genre-bars">
              \${top10.map(g => \`
                <div class="genre-bar-row">
                  <span class="genre-bar-name">\${g.name}</span>
                  <div class="genre-bar-container">
                    <div class="genre-bar" style="width: \${(g.count / maxCount * 100)}%"></div>
                  </div>
                  <span class="genre-bar-count">\${g.count}</span>
                </div>
              \`).join('')}
            </div>
          </div>

          <div class="stats-section">
            <h4>\${swedishMode ? 'MÃ¥ngfaldsmÃ¤tare' : 'Diversity Score'}</h4>
            <div class="diversity-meter">
              <div class="diversity-fill" style="width: \${diversityScore}%"></div>
            </div>
            <div class="diversity-info">
              <span class="diversity-score">\${diversityScore}%</span>
              <span class="diversity-label">\${getDiversityLabel(diversityScore)}</span>
            </div>
          </div>

          <div class="stats-section stats-grid">
            <div class="stat-box">
              <div class="stat-box-value">\${avgGenres}</div>
              <div class="stat-box-label">\${swedishMode ? 'Genrer per lÃ¥t (snitt)' : 'Avg genres per track'}</div>
            </div>
            <div class="stat-box">
              <div class="stat-box-value">\${genreData.totalArtists?.toLocaleString() || 'â€”'}</div>
              <div class="stat-box-label">\${swedishMode ? 'Unika artister' : 'Unique artists'}</div>
            </div>
          </div>
        </div>
      \`;
    }

    function renderGenres() {
      const filteredGenres = filterGenres('');
      const cacheInfo = genreData.cachedAt
        ? \`<span class="cache-info" title="\${genreData.fromCache ? (swedishMode ? 'FrÃ¥n cache' : 'From cache') : (swedishMode ? 'Nyss hÃ¤mtad' : 'Just fetched')}">
            \${genreData.fromCache ? 'âš¡' : 'âœ¨'} \${formatCacheTime(genreData.cachedAt)}
          </span>\`
        : '';

      app.innerHTML = \`
        <div class="stats">
          <div class="stat">
            <div class="stat-value">\${genreData.totalTracks.toLocaleString()}</div>
            <div class="stat-label" data-i18n="likedSongs">\${t('likedSongs')}</div>
          </div>
          <div class="stat">
            <div class="stat-value">\${genreData.totalGenres.toLocaleString()}</div>
            <div class="stat-label" data-i18n="genresFound">\${t('genresFound')}</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="selected-count">0</div>
            <div class="stat-label" data-i18n="selected">\${t('selected')}</div>
          </div>
        </div>

        \${genreData.truncated ? \`
        <div class="truncation-warning">
          âš ï¸ \${swedishMode
            ? \`Visar \${genreData.totalTracks.toLocaleString()} av \${genreData.totalInLibrary?.toLocaleString()} lÃ¥tar\`
            : \`Showing \${genreData.totalTracks.toLocaleString()} of \${genreData.totalInLibrary?.toLocaleString()} tracks\`}
          <button onclick="loadFullLibrary()" class="btn btn-ghost btn-sm" style="margin-left: 0.5rem;">
            \${swedishMode ? 'Ladda alla' : 'Load all'}
          </button>
        </div>
        \` : ''}

        <div class="cache-status">
          \${cacheInfo}
          <button onclick="refreshGenres()" class="btn btn-ghost btn-sm" title="\${swedishMode ? 'HÃ¤mta ny data frÃ¥n Spotify' : 'Fetch fresh data from Spotify'}">
            ðŸ”„ \${swedishMode ? 'Uppdatera' : 'Refresh'}
          </button>
          <button id="theme-toggle" onclick="toggleTheme()" class="btn btn-ghost btn-sm" title="\${lightMode ? (swedishMode ? 'Byt till mÃ¶rkt lÃ¤ge' : 'Switch to dark mode') : (swedishMode ? 'Byt till ljust lÃ¤ge' : 'Switch to light mode')}">
            \${lightMode ? 'ðŸŒ™' : 'â˜€ï¸'}
          </button>
        </div>

        <div class="toolbar-row">
          <button onclick="toggleStatsDashboard()" class="btn btn-ghost btn-sm stats-toggle" id="stats-toggle">
            \${showStatsDashboard ? (swedishMode ? 'ðŸ“Š DÃ¶lj statistik' : 'ðŸ“Š Hide Stats') : (swedishMode ? 'ðŸ“Š Visa statistik' : 'ðŸ“Š Show Stats')}
          </button>
          <button onclick="exportGenresJSON()" class="btn btn-ghost btn-sm" title="\${swedishMode ? 'Exportera som JSON' : 'Export as JSON'}">
            ðŸ“¥ JSON
          </button>
          <button onclick="exportGenresCSV()" class="btn btn-ghost btn-sm" title="\${swedishMode ? 'Exportera som CSV' : 'Export as CSV'}">
            ðŸ“¥ CSV
          </button>
        </div>

        \${renderStatsDashboard()}

        <div class="hidden-toolbar" id="hidden-toolbar" style="display: \${hiddenGenres.size > 0 ? 'flex' : 'none'}">
          <span>\${swedishMode ? 'Dolda genrer:' : 'Hidden genres:'} <strong id="hidden-count">\${hiddenGenres.size}</strong></span>
          <button onclick="toggleShowHidden()" class="btn btn-ghost btn-sm">
            \${showHiddenGenres ? (swedishMode ? 'ðŸ™ˆ DÃ¶lj dolda' : 'ðŸ™ˆ Hide hidden') : (swedishMode ? 'ðŸ‘ï¸ Visa dolda' : 'ðŸ‘ï¸ Show hidden')}
          </button>
          <button onclick="unhideAllGenres()" class="btn btn-ghost btn-sm" title="\${swedishMode ? 'Visa alla genrer' : 'Show all genres'}">
            â†º \${swedishMode ? 'Visa alla' : 'Unhide all'}
          </button>
          <button onclick="hideSmallGenres(5)" class="btn btn-ghost btn-sm" title="\${swedishMode ? 'DÃ¶lj genrer med fÃ¤rre Ã¤n 5 lÃ¥tar' : 'Hide genres with fewer than 5 tracks'}">
            \${swedishMode ? 'DÃ¶lj smÃ¥ (<5)' : 'Hide small (<5)'}
          </button>
        </div>

        <div class="card">
          <h2 class="card-title" data-i18n="yourGenres">\${t('yourGenres')}</h2>

          <div class="template-settings">
            <label>\${swedishMode ? 'Spellistnamn mall' : 'Playlist Name Template'}</label>
            <div class="template-input-row">
              <input
                type="text"
                class="search-input"
                id="template-input"
                value="\${playlistTemplate.replace(/"/g, '&quot;')}"
                oninput="updatePlaylistTemplate(this.value)"
                placeholder="{genre} (from Likes)"
              >
              <button onclick="resetTemplate()" class="btn btn-ghost btn-sm" title="\${swedishMode ? 'Ã…terstÃ¤ll' : 'Reset'}">â†º</button>
            </div>
            <div class="template-preview">
              \${swedishMode ? 'FÃ¶rhandsvisning:' : 'Preview:'} <span id="template-preview">\${getTemplatePreview()}</span>
            </div>
          </div>

          <input
            type="text"
            class="search-input"
            placeholder="\${t('searchGenres')}"
            data-i18n-placeholder="searchGenres"
            oninput="filterAndRenderGenres(this.value)"
          >
          <div class="genre-list" id="genre-list"></div>
          <div class="actions">
            <button onclick="selectAll()" class="btn btn-secondary" data-i18n="selectAll">\${t('selectAll')}</button>
            <button onclick="selectNone()" class="btn btn-secondary" data-i18n="selectNone">\${t('selectNone')}</button>
            <button onclick="createSelectedPlaylists()" class="btn btn-primary" id="create-btn" disabled data-i18n="createPlaylists">
              \${t('createPlaylists')}
            </button>
          </div>
        </div>

        <div id="results"></div>
      \`;

      renderGenreList(filteredGenres);
    }

    function filterGenres(query) {
      let filtered = genreData.genres;

      // Filter by search query
      if (query) {
        const lower = query.toLowerCase();
        filtered = filtered.filter(g => g.name.toLowerCase().includes(lower));
      }

      // Filter hidden genres (unless showing hidden)
      if (!showHiddenGenres) {
        filtered = filtered.filter(g => !hiddenGenres.has(g.name));
      }

      return filtered;
    }

    function filterAndRenderGenres(query) {
      const filtered = filterGenres(query);
      renderGenreList(filtered);
    }

    function renderGenreList(genres) {
      const list = document.getElementById('genre-list');
      list.innerHTML = genres.map(genre => {
        const isHidden = hiddenGenres.has(genre.name);
        return \`
        <label class="genre-item\${isHidden ? ' hidden' : ''}">
          <input
            type="checkbox"
            class="genre-checkbox"
            value="\${genre.name}"
            \${selectedGenres.has(genre.name) ? 'checked' : ''}
            onchange="toggleGenre('\${genre.name.replace(/'/g, "\\\\'")}', this.checked)"
          >
          <span class="genre-name">\${genre.name}</span>
          <span class="genre-count">\${genre.count} \${t('tracks')}</span>
          <button
            class="btn btn-ghost genre-hide"
            onclick="event.preventDefault(); toggleHideGenre('\${genre.name.replace(/'/g, "\\\\'")}')"
            title="\${isHidden ? (swedishMode ? 'Visa' : 'Show') : (swedishMode ? 'DÃ¶lj' : 'Hide')}"
          >
            \${isHidden ? 'ðŸ‘ï¸' : 'ðŸ™ˆ'}
          </button>
          <button
            class="btn btn-ghost genre-create"
            onclick="event.preventDefault(); createPlaylist('\${genre.name.replace(/'/g, "\\\\'")}')"
            data-i18n="create"
          >
            \${t('create')}
          </button>
        </label>
      \`}).join('');
    }

    function toggleGenre(name, checked) {
      if (checked) {
        selectedGenres.add(name);
      } else {
        selectedGenres.delete(name);
      }
      updateSelectedCount();
    }

    function updateSelectedCount() {
      document.getElementById('selected-count').textContent = selectedGenres.size;
      document.getElementById('create-btn').disabled = selectedGenres.size === 0;
      const mergeBtn = document.getElementById('merge-btn');
      if (mergeBtn) {
        mergeBtn.disabled = selectedGenres.size < 2; // Need at least 2 to merge
      }
    }

    // Playlist template functions
    function getTemplatePreview() {
      const exampleGenre = genreData?.genres?.[0]?.name || 'rock';
      return applyTemplate(exampleGenre);
    }

    function applyTemplate(genre) {
      return playlistTemplate.replace('{genre}', genre);
    }

    function updatePlaylistTemplate(value) {
      playlistTemplate = value || '{genre} (from Likes)';
      localStorage.setItem('playlistTemplate', playlistTemplate);
      const preview = document.getElementById('template-preview');
      if (preview) {
        preview.textContent = getTemplatePreview();
      }
    }

    function resetTemplate() {
      playlistTemplate = '{genre} (from Likes)';
      localStorage.setItem('playlistTemplate', playlistTemplate);
      const input = document.getElementById('template-input');
      const preview = document.getElementById('template-preview');
      if (input) input.value = playlistTemplate;
      if (preview) preview.textContent = getTemplatePreview();
    }

    function selectAll() {
      const checkboxes = document.querySelectorAll('.genre-checkbox');
      checkboxes.forEach(cb => {
        cb.checked = true;
        selectedGenres.add(cb.value);
      });
      updateSelectedCount();
    }

    function selectNone() {
      selectedGenres.clear();
      const checkboxes = document.querySelectorAll('.genre-checkbox');
      checkboxes.forEach(cb => cb.checked = false);
      updateSelectedCount();
    }

    // Show playlist customisation modal
    function showCustomiseModal(genreName) {
      const genre = genreData.genres.find(g => g.name === genreName);
      if (!genre) return;

      const defaultName = genreName + ' (from Likes)';
      const defaultDesc = genreName + ' tracks from your liked songs';

      const modal = document.createElement('div');
      modal.className = 'customise-modal';
      modal.innerHTML = [
        '<div class="customise-panel">',
        '  <div class="customise-header">',
        '    <h3>' + (swedishMode ? 'âœï¸ Anpassa spellista' : 'âœï¸ Customise Playlist') + '</h3>',
        '    <button class="customise-close" onclick="this.closest(\'.customise-modal\').remove()">&times;</button>',
        '  </div>',
        '  <div class="customise-body">',
        '    <div class="customise-field">',
        '      <label>' + (swedishMode ? 'Namn' : 'Name') + '</label>',
        '      <input type="text" id="custom-name" value="' + escapeForHtml(defaultName) + '" maxlength="100">',
        '    </div>',
        '    <div class="customise-field">',
        '      <label>' + (swedishMode ? 'Beskrivning' : 'Description') + '</label>',
        '      <textarea id="custom-desc" maxlength="300">' + escapeForHtml(defaultDesc) + '</textarea>',
        '      <div class="field-hint">' + (swedishMode ? 'Max 300 tecken' : 'Max 300 characters') + '</div>',
        '    </div>',
        '    <div class="customise-preview">',
        '      <div class="customise-preview-title">' + (swedishMode ? 'FÃ¶rhandsvisning' : 'Preview') + '</div>',
        '      <div class="customise-preview-name" id="preview-name">' + escapeForHtml(defaultName) + '</div>',
        '      <div class="customise-preview-desc" id="preview-desc">' + escapeForHtml(defaultDesc) + '</div>',
        '    </div>',
        '    <div style="display: flex; align-items: center; gap: 0.5rem;">',
        '      <span class="customise-track-count">ðŸŽµ ' + genre.count + ' ' + (swedishMode ? 'lÃ¥tar' : 'tracks') + '</span>',
        '    </div>',
        '  </div>',
        '  <div class="customise-footer">',
        '    <button class="btn btn-ghost" onclick="this.closest(\'.customise-modal\').remove()">',
        '      ' + (swedishMode ? 'Avbryt' : 'Cancel'),
        '    </button>',
        '    <button class="btn btn-primary" id="create-custom-btn">',
        '      ' + (swedishMode ? 'Skapa spellista' : 'Create Playlist'),
        '    </button>',
        '  </div>',
        '</div>'
      ].join('');

      document.body.appendChild(modal);

      // Update preview on input
      const nameInput = document.getElementById('custom-name');
      const descInput = document.getElementById('custom-desc');
      const previewName = document.getElementById('preview-name');
      const previewDesc = document.getElementById('preview-desc');

      nameInput.addEventListener('input', () => {
        previewName.textContent = nameInput.value || defaultName;
      });

      descInput.addEventListener('input', () => {
        previewDesc.textContent = descInput.value || defaultDesc;
      });

      // Handle create button
      document.getElementById('create-custom-btn').addEventListener('click', async () => {
        const customName = nameInput.value.trim();
        const customDesc = descInput.value.trim();
        modal.remove();
        await createPlaylistWithOptions(genreName, customName, customDesc);
      });

      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      // Focus name input
      nameInput.focus();
      nameInput.select();
    }

    // Create playlist with custom options
    async function createPlaylistWithOptions(genreName, customName, customDescription, force = false) {
      const genre = genreData.genres.find(g => g.name === genreName);
      if (!genre) return;

      try {
        const response = await fetch('/api/playlist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            genre: genre.name,
            trackIds: genre.trackIds,
            force,
            customName: customName || undefined,
            customDescription: customDescription || undefined
          }),
        });

        const result = await response.json();

        if (result.success) {
          showNotification(
            (swedishMode ? 'Skapade spellista: ' : 'Created playlist: ') + result.playlist.name + ' (' + genre.count + ' ' + t('tracks') + ')',
            'success'
          );
        } else if (result.duplicate) {
          showNotification(swedishMode ? 'Spellista finns redan' : 'Playlist already exists', 'error');
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showNotification(t('failed') + ': ' + error.message, 'error');
      }
    }

    // Show merge modal for combining selected genres
    function showMergeModal() {
      if (selectedGenres.size < 2) return;

      const genreNames = Array.from(selectedGenres);
      const genres = genreNames.map(name => genreData.genres.find(g => g.name === name)).filter(Boolean);
      const totalTracks = genres.reduce((sum, g) => sum + g.count, 0);
      const uniqueTrackIds = [...new Set(genres.flatMap(g => g.trackIds))];

      const defaultName = genreNames.slice(0, 3).join(' + ') + (genreNames.length > 3 ? ' +more' : '') + ' Mix';
      const defaultDesc = 'Combined playlist: ' + genreNames.join(', ');

      const modal = document.createElement('div');
      modal.className = 'customise-modal';
      modal.innerHTML = [
        '<div class="customise-panel">',
        '  <div class="customise-header">',
        '    <h3>' + (swedishMode ? 'ðŸ”— SlÃ¥ ihop genrer' : 'ðŸ”— Merge Genres') + '</h3>',
        '    <button class="customise-close" onclick="this.closest(\'.customise-modal\').remove()">&times;</button>',
        '  </div>',
        '  <div class="customise-body">',
        '    <div style="margin-bottom: 1rem; padding: 0.75rem; background: var(--bg); border-radius: 8px;">',
        '      <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">' + (swedishMode ? 'Valda genrer:' : 'Selected genres:') + '</div>',
        '      <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">',
        genreNames.map(name => '<span class="genre-tag">' + escapeForHtml(name) + '</span>').join(''),
        '      </div>',
        '    </div>',
        '    <div class="customise-field">',
        '      <label>' + (swedishMode ? 'Spellistans namn' : 'Playlist Name') + '</label>',
        '      <input type="text" id="merge-name" value="' + escapeForHtml(defaultName) + '" maxlength="100">',
        '    </div>',
        '    <div class="customise-field">',
        '      <label>' + (swedishMode ? 'Beskrivning' : 'Description') + '</label>',
        '      <textarea id="merge-desc" maxlength="300">' + escapeForHtml(defaultDesc) + '</textarea>',
        '    </div>',
        '    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">',
        '      <span class="customise-track-count">ðŸŽµ ' + uniqueTrackIds.length + ' ' + (swedishMode ? 'unika lÃ¥tar' : 'unique tracks') + '</span>',
        '      <span style="color: var(--text-muted); font-size: 0.85rem;">' + (swedishMode ? '(av ' + totalTracks + ' totalt)' : '(of ' + totalTracks + ' total)') + '</span>',
        '    </div>',
        '  </div>',
        '  <div class="customise-footer">',
        '    <button class="btn btn-ghost" onclick="this.closest(\'.customise-modal\').remove()">',
        '      ' + (swedishMode ? 'Avbryt' : 'Cancel'),
        '    </button>',
        '    <button class="btn btn-primary" id="merge-create-btn">',
        '      ' + (swedishMode ? 'ðŸ”— Skapa mix' : 'ðŸ”— Create Mix'),
        '    </button>',
        '  </div>',
        '</div>'
      ].join('');

      document.body.appendChild(modal);

      // Handle create button
      document.getElementById('merge-create-btn').addEventListener('click', async () => {
        const customName = document.getElementById('merge-name').value.trim();
        const customDesc = document.getElementById('merge-desc').value.trim();
        modal.remove();
        await createMergedPlaylist(genreNames, uniqueTrackIds, customName, customDesc);
      });

      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });

      // Focus name input
      document.getElementById('merge-name').focus();
    }

    // Create merged playlist from multiple genres
    async function createMergedPlaylist(genreNames, trackIds, customName, customDescription) {
      try {
        const response = await fetch('/api/playlist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            genre: genreNames[0], // Use first genre as base
            trackIds: trackIds,
            force: true, // Skip duplicate check for merged playlists
            customName: customName || genreNames.join(' + ') + ' Mix',
            customDescription: customDescription || 'Merged: ' + genreNames.join(', ')
          }),
        });

        const result = await response.json();

        if (result.success) {
          showNotification(
            (swedishMode ? 'ðŸ”— Skapade mix: ' : 'ðŸ”— Created mix: ') + result.playlist.name + ' (' + trackIds.length + ' ' + t('tracks') + ')',
            'success'
          );
          // Clear selection after successful merge
          selectedGenres.clear();
          updateSelectedCount();
          const checkboxes = document.querySelectorAll('.genre-checkbox');
          checkboxes.forEach(cb => cb.checked = false);
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        showNotification(t('failed') + ': ' + error.message, 'error');
      }
    }

    function showPlaylistCustomizeModal(genre) {
      const defaultName = playlistTemplate.replace('{genre}', genre.name);
      const defaultDescription = \`\${genre.name} tracks from your liked songs â™«\`;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = \`
        <div class="modal playlist-customize-modal">
          <h3>\${swedishMode ? \`ðŸŽµ Anpassa spellista fÃ¶r "\${escapeForHtml(genre.name)}"\` : \`ðŸŽµ Customize "\${escapeForHtml(genre.name)}" Playlist\`}</h3>

          <div class="form-group">
            <label for="playlist-name">\${swedishMode ? 'Namn:' : 'Name:'}</label>
            <input
              type="text"
              id="playlist-name"
              class="search-input"
              value="\${escapeForHtml(defaultName)}"
              maxlength="100"
              placeholder="\${swedishMode ? 'Spellistans namn' : 'Playlist name'}"
            />
          </div>

          <div class="form-group">
            <label for="playlist-description">\${swedishMode ? 'Beskrivning:' : 'Description:'}</label>
            <textarea
              id="playlist-description"
              class="search-input"
              rows="3"
              maxlength="300"
              placeholder="\${swedishMode ? 'Valfri beskrivning (max 300 tecken)' : 'Optional description (max 300 chars)'}"
            >\${escapeForHtml(defaultDescription)}</textarea>
            <div class="char-count" style="text-align: right; font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem;">
              <span id="desc-char-count">0</span>/300
            </div>
          </div>

          <div class="playlist-preview">
            <div class="preview-icon">\${getGenreEmoji(genre.name)}</div>
            <div class="preview-info">
              <div class="preview-tracks">\${genre.count} \${t('tracks')}</div>
              <div class="preview-hint">\${swedishMode ? 'Kommer att lÃ¤ggas till i spellistan' : 'Will be added to playlist'}</div>
            </div>
          </div>

          <div class="modal-actions">
            <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">
              \${swedishMode ? 'Avbryt' : 'Cancel'}
            </button>
            <button class="btn btn-primary" id="create-customized-btn">
              \${swedishMode ? 'Skapa Spellista' : 'Create Playlist'}
            </button>
          </div>
        </div>
      \`;

      document.body.appendChild(modal);

      // Update character count
      const descTextarea = modal.querySelector('#playlist-description');
      const charCount = modal.querySelector('#desc-char-count');
      function updateCharCount() {
        charCount.textContent = descTextarea.value.length;
      }
      descTextarea.addEventListener('input', updateCharCount);
      updateCharCount();

      // Handle create button click
      modal.querySelector('#create-customized-btn').addEventListener('click', () => {
        const customName = modal.querySelector('#playlist-name').value.trim();
        const customDescription = modal.querySelector('#playlist-description').value.trim();

        modal.remove();

        createPlaylist(genre.name, false, {
          name: customName || null,
          description: customDescription || null,
        });
      });

      // Close on overlay click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.remove();
        }
      });

      // Focus name input
      setTimeout(() => {
        modal.querySelector('#playlist-name')?.select();
      }, 100);
    }

    async function createPlaylist(genreName, force = false, customization = null) {
      const genre = genreData.genres.find(g => g.name === genreName);
      if (!genre) return;

      // If no customization provided and not forcing, show customization modal first
      if (!customization && !force) {
        showPlaylistCustomizeModal(genre);
        return;
      }

      const btn = event?.target;
      if (btn) {
        btn.disabled = true;
        btn.textContent = t('creating');
      }

      try {
        const requestBody = {
          genre: genre.name,
          trackIds: genre.trackIds,
          force,
          ...(customization?.name && { customName: customization.name }),
          ...(customization?.description && { customDescription: customization.description }),
        };

        const response = await fetch('/api/playlist', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody),
        });

        const result = await response.json();

        if (result.success) {
          if (btn) {
            btn.textContent = t('created');
            btn.style.color = 'var(--accent)';
          }
          showNotification(\`\${swedishMode ? 'Skapade spellista' : 'Created playlist'}: \${genre.name} (\${genre.count} \${t('tracks')})\`, 'success');
        } else if (result.duplicate) {
          // Show duplicate confirmation dialog
          showDuplicateDialog(genre, result);
          if (btn) {
            btn.disabled = false;
            btn.textContent = t('create');
          }
          return;
        } else {
          throw new Error(result.error);
        }
      } catch (error) {
        if (btn) {
          btn.textContent = t('failed');
          btn.style.color = 'var(--danger)';
        }
        showNotification(\`\${t('failed')}: \${error.message}\`, 'error');
      }

      if (btn) {
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = t('create');
          btn.style.color = '';
        }, 3000);
      }
    }

    function showDuplicateDialog(genre, result) {
      const existingCount = result.existingPlaylist.trackCount;
      const newCount = genre.count;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = \`
        <div class="modal">
          <h3>\${swedishMode ? 'Spellista finns redan' : 'Playlist Already Exists'}</h3>
          <p>\${result.message}</p>
          <p style="color: var(--text-muted); font-size: 0.9rem;">
            \${swedishMode
              ? \`Ny: \${newCount} lÃ¥tar, Befintlig: \${existingCount} lÃ¥tar\`
              : \`New: \${newCount} tracks, Existing: \${existingCount} tracks\`}
          </p>
          <div class="modal-actions">
            <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">
              \${swedishMode ? 'Avbryt' : 'Cancel'}
            </button>
            <button class="btn btn-primary" onclick="createPlaylistForce('\${genre.name.replace(/'/g, "\\\\'")}'); this.closest('.modal-overlay').remove();">
              \${swedishMode ? 'Skapa Ã¤ndÃ¥' : 'Create Anyway'}
            </button>
          </div>
        </div>
      \`;
      document.body.appendChild(modal);
    }

    function createPlaylistForce(genreName) {
      createPlaylist(genreName, true);
    }

    // ================== LOADING ANIMATION ==================

    // Get random album art from genre tracks (uses Spotify album images)
    function getAlbumArtForGenre(genreName) {
      // Default album art placeholder
      const defaultArt = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="#282828" width="100" height="100"/><circle cx="50" cy="50" r="40" fill="#1DB954"/><circle cx="50" cy="50" r="15" fill="#282828"/></svg>');

      // If we have track album art in genreData, use it
      const genre = genreData?.genres?.find(g => g.name === genreName);
      if (genre?.albumArts && genre.albumArts.length > 0) {
        // Get up to 5 random album arts
        const shuffled = [...genre.albumArts].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, 5);
      }

      // Return default placeholders
      return [defaultArt, defaultArt, defaultArt, defaultArt, defaultArt];
    }

    // Dynamic completion messages
    const completionMessages = {
      en: [
        "Your playlists are ready! Time to vibe ðŸŽµ",
        "Boom! Genre magic complete âœ¨",
        "Playlists created! Your music, organised ðŸŽ§",
        "Done! Your Spotify just got an upgrade ðŸš€",
        "Nailed it! Happy listening ðŸŽ¶",
        "All sorted! Your ears will thank you ðŸ‘‚",
        "Genre Genie has worked their magic! ðŸ§ž",
        "Playlist perfection achieved! ðŸ’¯",
      ],
      sv: [
        "Dina spellistor Ã¤r klara! Dags att njuta ðŸŽµ",
        "Klart! Genre-magi slutfÃ¶rd âœ¨",
        "Spellistor skapade! Din musik, organiserad ðŸŽ§",
        "Klart! Din Spotify blev just uppgraderad ðŸš€",
        "Perfekt! Trevlig lyssning ðŸŽ¶",
        "Allt sorterat! Dina Ã¶ron tackar dig ðŸ‘‚",
        "Genre Genie har trollat! ðŸ§ž",
        "Spellistperfektion uppnÃ¥dd! ðŸ’¯",
      ]
    };

    function getRandomCompletionMessage() {
      const messages = swedishMode ? completionMessages.sv : completionMessages.en;
      return messages[Math.floor(Math.random() * messages.length)];
    }

    // Show loading modal with album art animation
    function showLoadingModal(total) {
      // Collect album art from all selected genres
      const allAlbumArts = [];
      for (const genreName of selectedGenres) {
        const arts = getAlbumArtForGenre(genreName);
        allAlbumArts.push(...arts);
      }
      // Shuffle and take up to 5
      const shuffled = [...new Set(allAlbumArts)].sort(() => 0.5 - Math.random()).slice(0, 5);

      const modal = document.createElement('div');
      modal.className = 'playlist-loading-modal';
      modal.id = 'loading-modal';
      modal.innerHTML = \`
        <div class="album-carousel">
          \${shuffled.map(art => \`<img class="album-art" src="\${art}" alt="" onerror="this.style.background='var(--surface-2)'">\`).join('')}
        </div>
        <div class="loading-text" id="loading-text">\${swedishMode ? 'Skapar spellistor...' : 'Creating playlists...'}</div>
        <div class="loading-progress">
          <div class="loading-progress-bar" id="loading-progress-bar" style="width: 0%"></div>
        </div>
        <div class="loading-stats">
          <div class="loading-stat">
            <span class="loading-stat-value" id="loading-completed">0</span>
            <span>\${swedishMode ? 'Skapade' : 'Created'}</span>
          </div>
          <div class="loading-stat">
            <span class="loading-stat-value">\${total}</span>
            <span>\${swedishMode ? 'Totalt' : 'Total'}</span>
          </div>
        </div>
      \`;
      document.body.appendChild(modal);
    }

    // Update loading progress
    function updateLoadingProgress(completed, total, currentGenre) {
      const progressBar = document.getElementById('loading-progress-bar');
      const completedEl = document.getElementById('loading-completed');
      const textEl = document.getElementById('loading-text');

      if (progressBar) progressBar.style.width = \`\${(completed / total) * 100}%\`;
      if (completedEl) completedEl.textContent = completed;
      if (textEl && currentGenre) {
        textEl.textContent = swedishMode
          ? \`Skapar: \${currentGenre}...\`
          : \`Creating: \${currentGenre}...\`;
      }
    }

    // Hide loading modal
    function hideLoadingModal() {
      document.getElementById('loading-modal')?.remove();
    }

    // Show celebration animation
    function showCelebration(successful) {
      if (successful === 0) return;

      const overlay = document.createElement('div');
      overlay.className = 'celebration-overlay';

      // Create confetti pieces
      const colors = ['#1DB954', '#FFD700', '#FF6B6B', '#4ECDC4', '#9B59B6'];
      for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = \`\${Math.random() * 100}%\`;
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = \`\${Math.random() * 0.5}s\`;
        confetti.style.transform = \`rotate(\${Math.random() * 360}deg)\`;
        overlay.appendChild(confetti);
      }

      document.body.appendChild(overlay);

      // Remove after animation
      setTimeout(() => overlay.remove(), 3500);
    }

    async function createSelectedPlaylists() {
      if (selectedGenres.size === 0) return;

      const btn = document.getElementById('create-btn');
      btn.disabled = true;

      const genres = genreData.genres
        .filter(g => selectedGenres.has(g.name))
        .map(g => ({ name: g.name, trackIds: g.trackIds }));

      // Show loading modal with album art animation
      showLoadingModal(genres.length);

      try {
        const response = await fetch('/api/playlists/bulk', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ genres, skipDuplicates: true }),
        });

        const result = await response.json();

        // Hide loading modal
        hideLoadingModal();

        // Show celebration if playlists were created
        if (result.successful > 0) {
          showCelebration(result.successful);
        }

        const skippedText = result.skipped > 0
          ? \` (\${result.skipped} \${swedishMode ? 'hoppades Ã¶ver - finns redan' : 'skipped - already exist'})\`
          : '';

        // Show dynamic completion message
        const completionMessage = result.successful > 0 ? getRandomCompletionMessage() : '';

        document.getElementById('results').innerHTML = \`
          <div class="card">
            <h2 class="card-title" data-i18n="results">\${t('results')}</h2>
            \${completionMessage ? \`<p style="margin-bottom: 1rem; font-size: 1.1rem; color: var(--accent);">\${completionMessage}</p>\` : ''}
            <p style="margin-bottom: 1rem;">
              \${t('successCreated')} \${result.successful} \${t('of')} \${result.total} \${t('playlists')}\${skippedText}.
            </p>
            <div class="results">
              \${result.results.map(r => \`
                <div class="result-item">
                  <span>\${r.genre}</span>
                  \${r.success
                    ? \`<a href="\${r.url}" target="_blank" class="result-success" data-i18n="openSpotify">\${t('openSpotify')}</a>\`
                    : r.skipped
                      ? \`<span class="result-skipped">\${swedishMode ? 'Finns redan' : 'Already exists'}</span>\`
                      : \`<span class="result-error">\${r.error}</span>\`
                  }
                </div>
              \`).join('')}
            </div>
          </div>
        \`;

        selectedGenres.clear();
        updateSelectedCount();
        renderGenreList(filterGenres(''));

        // Reload recent playlists to show the new ones
        if (typeof loadRecentPlaylists === 'function') {
          loadRecentPlaylists();
        }
      } catch (error) {
        hideLoadingModal();
        showNotification(\`\${t('failed')}: \${error.message}\`, 'error');
      }

      btn.disabled = false;
      btn.textContent = t('createPlaylists');
    }

    function showNotification(message, type) {
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();

      const div = document.createElement('div');
      div.className = \`notification \${type}\`;
      div.style.cssText = \`
        position: fixed;
        bottom: 4rem;
        right: 2rem;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        background: \${type === 'success' ? 'var(--accent)' : 'var(--danger)'};
        color: \${type === 'success' ? '#000' : '#fff'};
        font-weight: 500;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        max-width: 300px;
      \`;
      div.textContent = message;
      document.body.appendChild(div);

      setTimeout(() => div.remove(), 5000);
    }

    // === Keyboard Shortcuts ===
    const SHORTCUTS = {
      '/': { desc: 'Focus search', action: () => document.querySelector('.search-input')?.focus() },
      'Escape': { desc: 'Clear search / close modal', action: handleEscape },
      'a': { desc: 'Select all (with Ctrl/Cmd)', ctrl: true, action: selectAll },
      'A': { desc: 'Select none (with Ctrl/Cmd+Shift)', ctrl: true, shift: true, action: selectNone },
      'Enter': { desc: 'Create playlists', action: () => {
        if (selectedGenres.size > 0 && !document.getElementById('create-btn')?.disabled) {
          createSelectedPlaylists();
        }
      }},
      'r': { desc: 'Refresh data', ctrl: true, action: (e) => { e.preventDefault(); refreshGenres(); }},
      't': { desc: 'Toggle theme', action: toggleTheme },
      's': { desc: 'Toggle stats', action: toggleStatsDashboard },
      '?': { desc: 'Show keyboard shortcuts', action: showKeyboardHelp },
    };

    function handleEscape() {
      // Close any modal first
      const modal = document.querySelector('.modal-overlay, .changelog-overlay, .deploy-overlay');
      if (modal) {
        modal.remove();
        document.querySelector('.changelog-panel, .deploy-refresh-prompt')?.remove();
        return;
      }
      // Clear search input
      const searchInput = document.querySelector('.search-input');
      if (searchInput && searchInput.value) {
        searchInput.value = '';
        filterAndRenderGenres('');
        searchInput.blur();
      }
    }

    function showKeyboardHelp() {
      const existingHelp = document.querySelector('.keyboard-help-overlay');
      if (existingHelp) {
        existingHelp.remove();
        return;
      }

      const overlay = document.createElement('div');
      overlay.className = 'keyboard-help-overlay';
      overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };

      const panel = document.createElement('div');
      panel.className = 'keyboard-help-panel';
      panel.setAttribute('role', 'dialog');
      panel.setAttribute('aria-labelledby', 'keyboard-help-title');

      const shortcuts = [
        { key: '/', desc: swedishMode ? 'SÃ¶k genrer' : 'Search genres' },
        { key: 'Esc', desc: swedishMode ? 'StÃ¤ng/Rensa' : 'Close/Clear' },
        { key: 'Ctrl+A', desc: swedishMode ? 'VÃ¤lj alla' : 'Select all' },
        { key: 'Ctrl+Shift+A', desc: swedishMode ? 'Avmarkera alla' : 'Select none' },
        { key: 'Enter', desc: swedishMode ? 'Skapa spellistor' : 'Create playlists' },
        { key: 'Ctrl+R', desc: swedishMode ? 'Uppdatera data' : 'Refresh data' },
        { key: 'T', desc: swedishMode ? 'VÃ¤xla tema' : 'Toggle theme' },
        { key: 'S', desc: swedishMode ? 'VÃ¤xla statistik' : 'Toggle stats' },
        { key: '?', desc: swedishMode ? 'Visa denna hjÃ¤lp' : 'Show this help' },
      ];

      panel.innerHTML = \`
        <h3 id="keyboard-help-title">\${swedishMode ? 'âŒ¨ï¸ TangentbordsgenvÃ¤gar' : 'âŒ¨ï¸ Keyboard Shortcuts'}</h3>
        <div class="shortcuts-list">
          \${shortcuts.map(s => \`
            <div class="shortcut-item">
              <kbd>\${s.key}</kbd>
              <span>\${s.desc}</span>
            </div>
          \`).join('')}
        </div>
        <button class="btn btn-ghost" onclick="this.closest('.keyboard-help-overlay').remove()">
          \${swedishMode ? 'StÃ¤ng' : 'Close'}
        </button>
      \`;

      overlay.appendChild(panel);
      document.body.appendChild(overlay);

      // Focus the close button for accessibility
      panel.querySelector('button')?.focus();
    }

    document.addEventListener('keydown', (e) => {
      // Don't trigger shortcuts when typing in inputs
      const isInput = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';

      // Escape always works
      if (e.key === 'Escape') {
        handleEscape();
        return;
      }

      // Skip other shortcuts if in input (except Ctrl combos)
      if (isInput && !e.ctrlKey && !e.metaKey) return;

      // Forward slash focuses search (unless already typing)
      if (e.key === '/' && !isInput) {
        e.preventDefault();
        document.querySelector('.search-input')?.focus();
        return;
      }

      // Check for matching shortcut
      const key = e.key;
      const shortcut = SHORTCUTS[key];
      if (!shortcut) return;

      const ctrlOrMeta = e.ctrlKey || e.metaKey;

      // Check modifiers match
      if (shortcut.ctrl && !ctrlOrMeta) return;
      if (shortcut.shift && !e.shiftKey) return;
      if (!shortcut.ctrl && ctrlOrMeta && key !== 'Enter') return;

      // Execute the shortcut
      e.preventDefault();
      shortcut.action(e);
    });

    // === Accessibility Improvements ===

    // Announce changes to screen readers
    function announceToScreenReader(message) {
      let announcer = document.getElementById('sr-announcer');
      if (!announcer) {
        announcer = document.createElement('div');
        announcer.id = 'sr-announcer';
        announcer.setAttribute('role', 'status');
        announcer.setAttribute('aria-live', 'polite');
        announcer.setAttribute('aria-atomic', 'true');
        announcer.className = 'sr-only';
        document.body.appendChild(announcer);
      }
      announcer.textContent = message;
    }

    // Enhanced notification with screen reader support
    const originalShowNotification = showNotification;
    showNotification = function(message, type) {
      originalShowNotification(message, type);
      announceToScreenReader(message);
    };

    // Announce selection changes
    const originalUpdateSelectedCount = updateSelectedCount;
    updateSelectedCount = function() {
      originalUpdateSelectedCount();
      const count = selectedGenres.size;
      if (count > 0) {
        announceToScreenReader(
          swedishMode
            ? \`\${count} genre\${count > 1 ? 'r' : ''} vald\${count > 1 ? 'a' : ''}\`
            : \`\${count} genre\${count > 1 ? 's' : ''} selected\`
        );
      }
    };

    // ================== SIDEBAR FUNCTIONS ==================

    let sidebarData = {
      pioneers: [],
      newUsers: [],
      recentPlaylists: []
    };
    let scoreboardData = null;
    let sidebarPollInterval = null;

    // Load leaderboard data (pioneers + new users)
    async function loadLeaderboard() {
      try {
        const response = await fetch('/api/leaderboard');
        if (!response.ok) return;
        const data = await response.json();
        sidebarData.pioneers = data.pioneers || [];
        sidebarData.newUsers = data.newUsers || [];
        renderPioneers();
        renderNewUsers();
      } catch (err) {
        // eslint-disable-next-line no-console
        console.error('Failed to load leaderboard:', err);
      }
    }

    // Load recent playlists
    async function loadRecentPlaylists() {
      try {
        const response = await fetch('/api/recent-playlists');
        if (!response.ok) return;
        const data = await response.json();
        sidebarData.recentPlaylists = data.playlists || [];
        renderRecentPlaylists();
      } catch (err) {
        // eslint-disable-next-line no-console
        console.error('Failed to load recent playlists:', err);
      }
    }

    // Render pioneers list in sidebar
    function renderPioneers() {
      const container = document.getElementById('pioneers-list');
      if (!container) return;

      if (sidebarData.pioneers.length === 0) {
        container.innerHTML = '<div class="sidebar-loading">' + (swedishMode ? 'Inga pionjÃ¤rer Ã¤n' : 'No pioneers yet') + '</div>';
        return;
      }

      container.innerHTML = sidebarData.pioneers.map((user, i) => {
        const posClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        const regalia = i === 0 ? '<span class="pioneer-badge first">ðŸ‘‘ First!</span>' :
                        i < 3 ? '<span class="pioneer-badge">ðŸ†</span>' :
                        i < 10 ? '<span class="regalia">â­</span>' : '';
        const delay = i * 50; // Stagger by 50ms

        return \`
          <div class="user-list-item animate-in" style="animation-delay: \${delay}ms" title="\${swedishMode ? 'Gick med' : 'Joined'} \${formatTimeAgo(new Date(user.registeredAt))}">
            <span class="position \${posClass}">#\${i + 1}</span>
            \${user.spotifyAvatar
              ? \`<img class="user-avatar" src="\${user.spotifyAvatar}" alt="" onerror="this.outerHTML='<div class=user-avatar-placeholder>ðŸ‘¤</div>'">\`
              : '<div class="user-avatar-placeholder">ðŸ‘¤</div>'}
            <span class="user-name">\${escapeHtml(user.spotifyName)}</span>
            \${regalia}
          </div>
        \`;
      }).join('');
    }

    // Render new users list in sidebar
    function renderNewUsers() {
      const container = document.getElementById('new-users-list');
      if (!container) return;

      if (sidebarData.newUsers.length === 0) {
        container.innerHTML = '<div class="sidebar-loading">' + (swedishMode ? 'Inga nya anvÃ¤ndare' : 'No new users') + '</div>';
        return;
      }

      container.innerHTML = sidebarData.newUsers.map((user, i) => {
        const delay = i * 50; // Stagger by 50ms
        return \`
          <div class="user-list-item animate-in" style="animation-delay: \${delay}ms">
            \${user.spotifyAvatar
              ? \`<img class="user-avatar" src="\${user.spotifyAvatar}" alt="" onerror="this.outerHTML='<div class=user-avatar-placeholder>ðŸ‘¤</div>'">\`
              : '<div class="user-avatar-placeholder">ðŸ‘¤</div>'}
            <span class="user-name">\${escapeHtml(user.spotifyName)}</span>
            <span class="regalia">\${formatTimeAgo(new Date(user.registeredAt))}</span>
          </div>
        \`;
      }).join('');
    }

    // Render recent playlists in sidebar
    function renderRecentPlaylists() {
      const container = document.getElementById('recent-playlists-list');
      if (!container) return;

      if (sidebarData.recentPlaylists.length === 0) {
        container.innerHTML = '<div class="sidebar-loading">' + (swedishMode ? 'Inga spellistor Ã¤n' : 'No playlists yet') + '</div>';
        return;
      }

      container.innerHTML = sidebarData.recentPlaylists.slice(0, 10).map((playlist, i) => {
        const delay = i * 50; // Stagger by 50ms
        const genreEmoji = getGenreEmoji(playlist.genre);
        return \`
          <a href="\${playlist.spotifyUrl}" target="_blank" class="playlist-list-item animate-in" style="animation-delay: \${delay}ms" title="\${playlist.trackCount} \${swedishMode ? 'lÃ¥tar' : 'tracks'}">
            <div class="playlist-icon">\${genreEmoji}</div>
            <div class="playlist-info">
              <div class="playlist-name">\${escapeHtml(playlist.playlistName)}</div>
              <div class="playlist-meta">
                <span class="playlist-creator">
                  \${playlist.createdBy.spotifyAvatar
                    ? \`<img class="creator-avatar" src="\${playlist.createdBy.spotifyAvatar}" alt="">\`
                    : ''}
                  \${escapeHtml(playlist.createdBy.spotifyName)}
                </span>
                <span>â€¢</span>
                <span>\${formatTimeAgo(new Date(playlist.createdAt))}</span>
              </div>
            </div>
          </a>
        \`;
      }).join('');
    }

    // Escape HTML for safe display
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    // Get emoji for genre (reuse existing or provide fallback)
    function getGenreEmoji(genre) {
      const emojiMap = {
        'rock': 'ðŸŽ¸', 'pop': 'ðŸŽ¤', 'hip hop': 'ðŸŽ§', 'rap': 'ðŸŽ¤', 'jazz': 'ðŸŽ·',
        'classical': 'ðŸŽ»', 'electronic': 'ðŸŽ¹', 'dance': 'ðŸ’ƒ', 'country': 'ðŸ¤ ',
        'r&b': 'ðŸŽµ', 'soul': 'ðŸ’œ', 'blues': 'ðŸŽº', 'metal': 'ðŸ¤˜', 'punk': 'âš¡',
        'folk': 'ðŸª•', 'indie': 'ðŸŒŸ', 'alternative': 'ðŸŽ¸', 'reggae': 'ðŸŒ´',
        'latin': 'ðŸ’ƒ', 'k-pop': 'ðŸ‡°ðŸ‡·', 'j-pop': 'ðŸ‡¯ðŸ‡µ', 'anime': 'ðŸŽŒ'
      };
      const lowerGenre = (genre || '').toLowerCase();
      for (const [key, emoji] of Object.entries(emojiMap)) {
        if (lowerGenre.includes(key)) return emoji;
      }
      return 'ðŸŽµ';
    }

    // Toggle sidebar visibility (mobile)
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const toggle = document.getElementById('sidebar-toggle');
      if (!sidebar) return;

      sidebar.classList.toggle('collapsed');
      const isCollapsed = sidebar.classList.contains('collapsed');

      if (toggle) {
        toggle.querySelector('.toggle-icon').textContent = isCollapsed ? 'â–¶' : 'â—€';
        toggle.setAttribute('aria-expanded', !isCollapsed);
      }
    }
    // Make toggleSidebar globally accessible
    window.toggleSidebar = toggleSidebar;

    // Show scoreboard modal
    async function showScoreboard() {
      // Fetch scoreboard data
      try {
        const response = await fetch('/api/scoreboard');
        if (!response.ok) throw new Error('Failed to fetch');
        scoreboardData = await response.json();
      } catch (err) {
        showNotification(swedishMode ? 'Kunde inte ladda resultattavlan' : 'Failed to load scoreboard', 'error');
        return;
      }

      // Create modal
      const modal = document.createElement('div');
      modal.className = 'scoreboard-modal active';
      modal.id = 'scoreboard-modal';
      modal.onclick = (e) => {
        if (e.target === modal) closeScoreboard();
      };

      modal.innerHTML = \`
        <div class="scoreboard-panel">
          <div class="scoreboard-header">
            <h2>ðŸ“Š \${swedishMode ? 'Resultattavla' : 'Scoreboard'}</h2>
            <button class="btn btn-ghost" onclick="closeScoreboard()">âœ•</button>
          </div>
          <div class="scoreboard-tabs">
            <button class="scoreboard-tab active" data-tab="playlists">ðŸŽµ \${swedishMode ? 'Spellistor' : 'Playlists'}</button>
            <button class="scoreboard-tab" data-tab="genres">ðŸŽ¸ \${swedishMode ? 'Genrer' : 'Genres'}</button>
            <button class="scoreboard-tab" data-tab="artists">ðŸŽ¤ \${swedishMode ? 'Artister' : 'Artists'}</button>
            <button class="scoreboard-tab" data-tab="tracks">ðŸ“€ \${swedishMode ? 'LÃ¥tar' : 'Tracks'}</button>
          </div>
          <div class="scoreboard-content" id="scoreboard-content">
            \${renderScoreboardTab('playlists')}
          </div>
          <div class="scoreboard-footer" title="\${swedishMode ? 'Statistik uppdateras var 1-24 timme. Donera till Bryan fÃ¶r snabbare uppdateringar!' : 'Stats refresh every 1-24 hours. Shout Bryan a durry for faster updates!'}">
            \${scoreboardData.totalUsers} \${swedishMode ? 'anvÃ¤ndare totalt' : 'total users'} â€¢
            \${swedishMode ? 'Uppdaterad' : 'Updated'} \${formatTimeAgo(new Date(scoreboardData.updatedAt))}
            <span style="opacity:0.5;font-size:0.7rem;margin-left:0.5rem">â„¹ï¸</span>
          </div>
        </div>
      \`;

      document.body.appendChild(modal);

      // Add tab click handlers
      modal.querySelectorAll('.scoreboard-tab').forEach(tab => {
        tab.onclick = () => {
          modal.querySelectorAll('.scoreboard-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById('scoreboard-content').innerHTML = renderScoreboardTab(tab.dataset.tab);
        };
      });
    }
    // Make showScoreboard globally accessible
    window.showScoreboard = showScoreboard;

    // Render a scoreboard tab
    function renderScoreboardTab(tab) {
      if (!scoreboardData) return '';

      const tabMap = {
        playlists: { data: scoreboardData.byPlaylists, label: swedishMode ? 'spellistor' : 'playlists' },
        genres: { data: scoreboardData.byGenres, label: swedishMode ? 'genrer' : 'genres' },
        artists: { data: scoreboardData.byArtists, label: swedishMode ? 'artister' : 'artists' },
        tracks: { data: scoreboardData.byTracks, label: swedishMode ? 'lÃ¥tar' : 'tracks' }
      };

      const { data, label } = tabMap[tab] || tabMap.playlists;

      if (!data || data.length === 0) {
        return \`<div class="sidebar-loading">\${swedishMode ? 'Inga data Ã¤n' : 'No data yet'}</div>\`;
      }

      return \`
        <div class="scoreboard-list">
          \${data.map(entry => {
            const rankClass = entry.rank === 1 ? 'gold' : entry.rank === 2 ? 'silver' : entry.rank === 3 ? 'bronze' : '';
            return \`
              <div class="scoreboard-entry">
                <span class="rank \${rankClass}">#\${entry.rank}</span>
                \${entry.spotifyAvatar
                  ? \`<img class="entry-avatar" src="\${entry.spotifyAvatar}" alt="" onerror="this.style.display='none'">\`
                  : '<div class="entry-avatar" style="background:var(--surface-2);display:flex;align-items:center;justify-content:center">ðŸ‘¤</div>'}
                <div class="entry-info">
                  <div class="entry-name">\${escapeHtml(entry.spotifyName)}</div>
                </div>
                <span class="entry-count">\${entry.count.toLocaleString()} \${label}</span>
              </div>
            \`;
          }).join('')}
        </div>
      \`;
    }

    // Close scoreboard modal
    function closeScoreboard() {
      document.getElementById('scoreboard-modal')?.remove();
    }
    window.closeScoreboard = closeScoreboard;

    // Initialize sidebar
    function initSidebar() {
      // Load initial data
      loadLeaderboard();
      loadRecentPlaylists();

      // Poll for recent playlists every 3 minutes (was 30s - reduced to save KV usage)
      function startPolling() {
        if (sidebarPollInterval) clearInterval(sidebarPollInterval);
        sidebarPollInterval = setInterval(() => {
          loadRecentPlaylists();
        }, 180000); // 3 minutes
      }

      startPolling();

      // Pause polling when tab is hidden to reduce KV reads
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          if (sidebarPollInterval) {
            clearInterval(sidebarPollInterval);
            sidebarPollInterval = null;
          }
        } else {
          // Tab became visible - refresh immediately then resume polling
          loadRecentPlaylists();
          startPolling();
        }
      });

      // On mobile, start with sidebar collapsed
      if (window.innerWidth <= 1024) {
        const sidebar = document.getElementById('sidebar');
        if (sidebar) sidebar.classList.add('collapsed');
      }
    }

    // Initialize
    init();

    // Start deployment monitor
    startDeployMonitor();

    // Initialize sidebar
    initSidebar();
  </script>
</body>
</html>`;
}
